<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="../helpproject.xsl" ?>
<topic template="Default" lasteditedby="robert" version="2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../helpproject.xsd">
  <title>Example 4: Ole Automation - Excel</title>
  <body>
    <header>
      <para styleclass="Heading1">Example 4: Ole Automation - Excel</para>
    </header>
    <para styleclass="Body Text">For the 4th example we will not use a standard example from Visual Objects but will create a new sample app in Visual Objects to remote control Excel and to write data to an Excel Sheet.</para>
    <para styleclass="Body Text">I found the following example in the Comp.Lang.Clipper.Visual-Objects newsgroup (which I changed a little bit for this example).</para>
    <list id="8" type="ul" listtype="bullet" formatstring="&#183;" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text">Create a new terminal application in Visual Objects and copy and paste the code below into the app.</li>
      <li styleclass="Body Text">Open the application Properties and add the Ole Library.</li>
      <li styleclass="Body Text">Also rename the app to &quot;ExcelTest&quot;.</li>
      <li styleclass="Body Text">Now open the start module and copy the code.</li>
      <li styleclass="Body Text">Compile and run, and you will find an xls file in the C:\ExcelTest folder.</li>
    </list>
    <para styleclass="Normal"></para>
    <para styleclass="Code Example"><text style="font-weight:bold; font-style:normal; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Start()</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> oExcel </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> OBJECT</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> oWorkBooks </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> OBJECT</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> oWorksheet </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> OBJECT</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> oRange </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> OBJECT</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> cFile </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">STRING</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">cFile := &quot;C:\ExcelTest\example.xls&quot;</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">DirMake(&quot;C:\ExcelTest&quot;)</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oExcel:=OLEAutoObject{&quot;Excel.Application&quot;}</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oExcel:Visible:=FALSE </text><text style="font-weight:bold; font-style:italic; color:#339966;">// Don&apos;t show the EXCEL execute</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oExcel:DisplayAlerts:=FALSE </text><text style="font-weight:bold; font-style:italic; color:#339966;">// Don&apos;t show messages</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oWorkBooks:=oExcel:Workbooks</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oWorkBooks:add() </text><text style="font-weight:bold; font-style:italic; color:#339966;">//open a new worksheet</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oWorkSheet:=oExcel:ActiveSheet </text><text style="font-weight:bold; font-style:italic; color:#339966;">// active the first sheet</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oRange:=oWorkSheet:[Range,&quot;A1&quot;,&quot;A1&quot;] </text><text style="font-weight:bold; font-style:italic; color:#339966;">// A1 cell</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oRange:SELECT()</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oRange:FormulaR1C1:=&quot;Hello my text&quot;</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oExcel:ActiveWorkBook:SaveAs(cFile,56,&quot;&quot;,&quot;&quot;,;</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;"> &#160; &#160; &#160;FALSE,FALSE) &#160;</text><text style="font-weight:bold; font-style:italic; color:#339966;">//&quot;56&quot; save the file in work book of EXCEL 97-2003 (Excel 8)</text><br/><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oWorkBooks:Close()</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oExcel:Quit() &#160; </text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">WAIT</text><br/><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">RETURN</text><text style="font-weight:normal; font-style:normal; color:#000000;"> NIL &#160; </text></para>
    <para styleclass="Normal"></para>
    <list id="9" type="ul" listtype="bullet" formatstring="&#183;" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text">Export the AEF to &quot;C:\ExcelTest\ExcelTest.AEF&quot;</li>
      <li styleclass="Body Text">Run the VOExporter and export the code.</li>
      <li styleclass="Body Text">After opening the solution inside Visual Studio you will also get an application with one source file (Start.prg). The source is almost identical with one difference. The line :</li>
    </list>
    <para styleclass="Code Example"><text style="font-weight:normal; font-style:normal; color:#000000;">oRange:=oWorkSheet:[Range,&quot;A1&quot;,&quot;A1&quot;] </text><text style="font-weight:bold; font-style:italic; color:#339966;">// A1 cell</text></para>
    <para styleclass="Normal" style="margin-left:13px;"></para>
    <para styleclass="Body Text">has been changed to</para>
    <para styleclass="Code Example"><text style="font-weight:normal; font-style:normal; color:#000000;">oRange:=oWorkSheet:Range[&quot;A1&quot;,&quot;A1&quot;] </text><text style="font-weight:bold; font-style:italic; color:#339966;">// A1 cell</text></para>
    <para styleclass="Body Text"></para>
    <list id="10" type="ul" listtype="bullet" formatstring="&#183;" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text">Note that the name Range is now in front of the Square brackets.<br/>Range is a so called &quot;Indexed property&quot; of the worksheet. Visual Objects uses a &quot;funny&quot; syntax for this. <br/>X# uses the same syntax that most other languages do. The property looks like an array (the square brackets) . </li>
    </list>
    <list id="11" type="ul" listtype="bullet" formatstring="&#183;" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text">Now compile the app in X#. You will get the following errors:</li>
    </list>
    <para styleclass="Body Text"><image src="ExcelOle.png" scale="-99.90%" width="1021" height="211" styleclass="Image Caption"></image></para>
    <para styleclass="Body Text">Let&apos;s look at these errors:</para>
    <list id="12" type="ul" listtype="bullet" formatstring="&#183;" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text">The last errors in the list indicate that the Start method is not correct. This is because the Start function in .Net has to either be a VOID function or a function that returns an INT. In this case no return type has been declared, so X# thinks you want to create a function that returns a USUAL. Change the prototype of the start function to:</li>
    </list>
    <para styleclass="Code Example"><text style="font-weight:bold; font-style:normal; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Start() </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">VOID</text></para>
    <para styleclass="Body Text" style="margin-left:13px;">and remove the NIL return value from the RETURN statement.<br/></para>
    <list id="13" type="ul" listtype="bullet" formatstring="&#183;" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text">Now 2 errors remain. These indicate that X# does not know how to convert the array index from string to int. This is on the line with the range assignment. <br/>The code above uses &apos;Late Binding&apos;, so the types are not known at compile time. X# does not know if the Range property from the Worksheet object is an indexed property or if it returns an array. It assumes that it returns an array and wants to specify the array index which is numeric (and subtract one because Visual Objects uses 1 based arrays where .Net uses 0 based arrays).</li>
      <li styleclass="Body Text">The best way to fix this is to use strong typing and use the Generated Class wrappers for Excel. <br/>In Visual Objects you would use the &apos;Automation Server&apos; tool to generate such a class wrapper. In .Net there is a similar tool. The easiest way to achieve this is to add a reference to Excel to the references of the application:</li>
      <li styleclass="Body Text">Right Click on &quot;References&quot; in the solution Explorer and Choose &quot;Add Reference&quot;</li>
      <li styleclass="Body Text">In the &apos;Add Reference&apos; dialog, choose the COM tabpage</li>
      <li styleclass="Body Text">Locate the &quot;Microsoft Excel nn.m Object Library&quot;. On my machine that is Excel 16.0.</li>
    </list>
    <para styleclass="Body Text"><image src="ExcelAddRef.png" scale="-99.90%" width="822" height="540" styleclass="Image Caption"></image></para>
    <list id="13" type="ul" listtype="bullet" formatstring="&#183;" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text"><text styleclass="Image Caption" style="font-style:normal;">Click Ok.</text></li>
      <li styleclass="Body Text"><text styleclass="Image Caption" style="font-style:normal;">This will add an entry to your References list with the name &quot;Microsoft.Office.Interop.Excel&quot;. This is a generated type library that contains class definitions for all types inside Excel.</text></li>
      <li styleclass="Body Text"><text styleclass="Image Caption" style="font-style:normal;">Now go into your code, add a Using statement for the namespace of the Excel classes and change &quot;AS OBJECT&quot; to the right types:</text></li>
    </list>
    <para styleclass="Code Example"><text style="font-weight:normal; font-style:normal; color:#000000;"> &#160; </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">USING</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Microsoft.Office.Interop.Excel</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;"> &#160; </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Start() </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">VOID</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;"> &#160; </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> oExcel </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Application</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;"> &#160; </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> oWorkBooks </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Workbooks</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;"> &#160; </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> oWorksheet </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Worksheet</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;"> &#160; </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> oRange </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Range</text></para>
    <para styleclass="Normal" style="margin-left:13px;"></para>
    <list id="13" type="ul" listtype="bullet" formatstring="&#183;" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text"><text styleclass="Image Caption" style="font-style:normal;">Also change the call to create the Main Excel object:</text></li>
    </list>
    <para styleclass="Normal"><tab /><text styleclass="Code Example">oExcel:=ApplicationClass{}</text><br/></para>
    <list id="14" type="ul" listtype="bullet" formatstring="&#183;" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Normal" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Normal"><text styleclass="Body Text">Your code is now strongly typed, so you should also get intellisense if you try to select a member from one of these objects, such as oExcel:Workbooks.</text></li>
    </list>
    <list id="15" type="ul" listtype="bullet" formatstring="&#183;" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text">Compile and run the code . It works as expected.</li>
      <li styleclass="Body Text">You may want to change the value <text style="font-weight:bold;">56</text> in the <text style="font-weight:bold;">SaveAs</text> line to the appropriate enum value:<text styleclass="Code Example"> xlFileFormat.xlExcel8</text></li>
      <li styleclass="Body Text">Now run the app again and everything works as expected.</li>
      <li styleclass="Body Text">If you look in the folder where the EXE is generated you will see both ExcelTest.Exe and Microsoft.Office.Interop.Excel.dll, the type library</li>
    </list>
    <para styleclass="Heading2">Note 1</para>
    <para styleclass="Body Text">If you are wondering why we declare oExcel as Application but use ApplicationClass to instantiate the object, here is the reason:</para>
    <para styleclass="Body Text"><text style="font-weight:bold;">Application</text> is the interface, <text style="font-weight:bold;">ApplicationClass</text> is the actual class that implements the Application interface. This is a model that you will see for most Automation Servers.</para>
    <para styleclass="Heading2">Note 2</para>
    <para styleclass="Body Text">Many people have asked for a way to implement OLE Events. With the X# code and the generated type library this is very easy.</para>
    <para styleclass="Body Text">Add the following code to the start method to define a BeforeSave and AfterSave event</para>
    <para styleclass="Code Example"><text style="font-weight:normal; font-style:normal; color:#000000;">oExcel:WorkbookBeforeSave += OnBeforeSave</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">oExcel:WorkbookAfterSave += OnAfterSave</text></para>
    <para styleclass="Normal"></para>
    <para styleclass="Body Text">and add the following functions</para>
    <para styleclass="Code Example"><text style="font-weight:bold; font-style:normal; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; color:#000000;"> OnBeforeSave (oWb </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Workbook, SaveAsUI </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> LOGIC, Cancel </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">REF</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Logic) </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">VOID</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">? &quot;OnBeforeSave&quot;, oWb:Path, oWb:Name, SaveAsUI</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">RETURN</text><br/><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; color:#000000;"> OnAfterSave (oWb </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Workbook, Success </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> LOGIC) </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">VOID</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">? &quot;OnAfterSave&quot;, oWb:Path, oWb:Name, Success</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">RETURN</text></para>
    <para styleclass="Body Text">And run the example again. You will see that both functions are called. Before the save the path and name are not set properly, afterwards they are set to the values specified in the code<br/><text style="font-weight:bold; font-style:italic;">Some versions of Excel do not support the WorkbookAfterSave event. In that case you will get a compile time error</text></para>
    <para styleclass="Body Text"></para>
    <para styleclass="List"><text style="font-weight:bold; font-style:italic;">Note</text><text style="font-style:italic;">: </text><tab />If you run this code through the debugger and set a break point in the OnBeforeSaveAs you will see that the callstack in these events is a little bit weird: <br/>there is no Start() function inside this callstack ( I have disabled the &apos;Just My code option&apos;, otherwise you would only see the line with OnBeforeSave())</para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text"><image src="CallStackExcel.png" scale="100.00%" styleclass="Image Caption"></image></para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text"><text style="font-weight:bold;">That is because these events are called on a separate thread. If you look at the Threads window in VS (Debug - Windows - Threads) you will see that:</text></para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text"><image src="ExcelThreadWindow.png" scale="100.00%" styleclass="Image Caption"></image></para>
    <para styleclass="Heading2">Note 3</para>
    <para styleclass="Normal">If you look closely in the Add References dialog you may also find other occurrences of the Excel library (on the .Net tab). On my machine these are:</para>
    <para styleclass="Normal"></para>
    <para styleclass="Normal"><image src="ExcelAddRef2.png" scale="-99.90%" width="758" height="51" styleclass="Image Caption"></image></para>
    <para styleclass="Normal"></para>
    <para styleclass="Normal">These are so called &quot;Primary Interop Assemblies&quot; (PIAs), pre-compiled assemblies, for different Excel versions. You can use these as well. These assemblies are installed with the Office Developers Tools for Visual Studio. On my machine they are located in subfolders of &quot;c:\Program Files (x86)\Microsoft Visual Studio 14.0\Visual Studio Tools for Office\PIA&quot; .</para>
    <para styleclass="Normal"></para>
    <para styleclass="Body Text"><text style="font-weight:bold;">You will find the &quot;code before&quot; and &quot;code after&quot; in the XSharp Examples folder</text></para>
  </body>
</topic>
