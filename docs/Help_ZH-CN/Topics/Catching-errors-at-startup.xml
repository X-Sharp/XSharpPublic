<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="../helpproject.xsl" ?>
<topic template="Default" modified="2024-07-26T12:07:31.821+08:00" lasteditedby="niuji" version="2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../helpproject.xsd">
  <title>在启动时捕获运行时错误</title>
  <keywords>
    <keyword>-main</keyword>
    <keyword>Start</keyword>
    <keyword>StartupCode</keyword>
    <keyword>UnhandledException</keyword>
  </keywords>
  <body>
    <header>
      <para styleclass="Heading1">在启动时捕获运行时错误</para>
    </header>
    <para styleclass="Normal"></para>
    <para styleclass="Normal">有时，程序在启动时会出现运行时错误。造成这些错误的原因可能是程序集丢失或初始化代码出错。</para>
    <para styleclass="Normal">这些错误可能很难捕获，因为错误发生在应用程序第一行代码之前执行的代码中。</para>
    <para styleclass="Normal">举例如下：</para>
    <para styleclass="Code Example"><text style="font-weight:bold; font-style:normal; color:#ff0000;">GLOBAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> x </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">INT</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">GLOBAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> y := 1 / x </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">INT</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">  </text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Start </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">VOID</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;"> ? &quot;Function Start&quot;</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">    </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">RETURN</text></para>
    <para styleclass="Body Text">这段代码会在启动时产生一个异常，只有在命令行下运行应用程序时才能看到或读取该异常</para>
    <para styleclass="Code Example">Unhandled Exception: System.TypeInitializationException: The type initializer for &apos;Application1.Exe.Functions&apos; threw an exception. ---&gt; System.DivideByZeroException: Attempted to divide by zero.<br/>at Application1.Exe.Functions..cctor() in C:\XIDE\Projects\Default\Applications\Application1\Prg\Start.prg:line 4<br/>--- End of inner exception stack trace ---<br/>at Application1.Exe.Functions.Start()</para>
    <para styleclass="Body Text">X# 应用程序的正常程序流程是这样的：</para>
    <list id="0" type="ul" listtype="bullet" formatstring="·" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text">启动应用程序</li>
      <li styleclass="Body Text">初始化 DotNet Framework</li>
      <li styleclass="Body Text">调用入口点。应用程序的正常入口点是 Start 函数，编译器会将其转换为编译器生成的 Functions 类中的 Start 方法。</li>
    </list>
    <para styleclass="Body Text">    该类还包含应用程序中的全局和定义。如果这些全局项或定义中包含一个在编译时无法解析的初始化表达式，那么这些代码将在 Functions 类的静态构造函数中执行(在上面的错误信息中称为 &quot;类型初始化器&quot;)。</para>
    <list id="0" type="ul" listtype="bullet" formatstring="·" format-charset="SYMBOL_CHARSET" levelreset="true" legalstyle="false" startfrom="1" styleclass="Body Text" style="font-family:Symbol; font-size:11pt; color:#000000;">
      <li styleclass="Body Text">上面的代码显然犯了一个错误，导致了除以零的错误。</li>
    </list>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text">为了拦截这种情况，我们希望在启动时运行一些其他代码，并添加一个 try ... catch 结构，以确保我们能捕捉到这种错误。</para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text">增加下面的代码：</para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text"><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">CLASS</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> MyStartupCode</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">STATIC</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">METHOD</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> Start </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">VOID</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">STRICT</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">  </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">TRY</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   </text><text styleclass="Code Example" style="font-weight:bold; font-style:italic; color:#339966;">// 请注意，在下面一行中，.Exe 前面的名称必须是</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   </text><text styleclass="Code Example" style="font-weight:bold; font-style:italic; color:#339966;">// 与 EXE 的文件名相匹配。在我的例子中，我生成的是 Application1.exe</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   Application1.Exe.Functions.Start()</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">  </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">CATCH</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> e </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> Exception  </text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   </text><text styleclass="Code Example" style="font-weight:bold; font-style:italic; color:#339966;">// 我们或许也应该将其记录到磁盘中 ！</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   Console.WriteLine(&quot;发生了未处理的异常&quot;)</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   Console.WriteLine(&quot;===================================&quot;)</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">DO</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">WHILE</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> e != </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">NULL</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">        </text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">     Console.WriteLine(&quot;Exception: &quot;+e:Message)                            </text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">     Console.WriteLine(&quot;Callstack:&quot;)</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">     Console.WriteLine(e:StackTrace)</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">     Console.WriteLine()</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">     e := e:InnerException</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">ENDDO</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">            </text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   Console.WriteLine(&quot;===================================&quot;)</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   Console.WriteLine(&quot;按任意键关闭程序&quot;)</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">   Console.ReadLine()   </text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">  </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">END</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">TRY</text><br/><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;">  </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">RETURN</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> </text><br/><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">END</text><text styleclass="Code Example" style="font-weight:normal; font-style:normal; color:#000000;"> </text><text styleclass="Code Example" style="font-weight:bold; font-style:normal; color:#ff0000;">CLASS</text></para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text">您可能需要将 Application1.Exe.Functions.Start() 的调用改为与您的 EXE 名称一致的名称。</para>
    <para styleclass="Body Text">现在进入 VS 应用程序属性中的常规页面，在 &quot;Startup Object(启动对象)&quot;中设置 MyStartupCode 的值。</para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text"><image src="StartupCode.png" scale="100.00%" styleclass="Image Caption" figurelistinclude="0"></image></para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text">在 XIDE 中添加命令行选项 -main:MyStartupCode：</para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text"><image src="XideStartup.png" scale="100.00%" styleclass="Image Caption" figurelistinclude="0"></image></para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text">并再次运行代码。</para>
    <para styleclass="Body Text">现在错误已被捕获并显示出来。</para>
    <para styleclass="Body Text">如果您的应用程序不是控制台应用程序，而是 Windows 应用程序，那么控制台输出可能不可见。</para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text">当然，你也可以在新启动代码中的 AppDomain 类中注册一个 UnHandledException 处理程序。</para>
    <para styleclass="Body Text">将代码更改为：</para>
    <para styleclass="Code Example"><text style="font-weight:bold; font-style:normal; color:#ff0000;">CLASS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> MyStartupCode</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">STATIC</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">METHOD</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Start </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">VOID</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">STRICT</text><text style="font-weight:normal; font-style:normal; color:#000000;">         </text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">  </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">TRY</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">   System.AppDomain.CurrentDomain:UnhandledException += ExceptionHandler</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">   Application1.Exe.Functions.Start()</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">  </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">CATCH</text><text style="font-weight:normal; font-style:normal; color:#000000;"> e </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Exception</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">   ExceptionHandler(</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">NULL</text><text style="font-weight:normal; font-style:normal; color:#000000;">, </text>UnhandledExceptionEventArgs<text style="font-weight:normal; font-style:normal; color:#000000;">{e, TRUE})</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">  </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">END</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">TRY</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">  </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">RETURN</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><br/><br/><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">STATIC</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">METHOD</text><text style="font-weight:normal; font-style:normal; color:#000000;"> ExceptionHandler( sender </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">OBJECT</text><text style="font-weight:normal; font-style:normal; color:#000000;">, args </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> UnhandledExceptionEventArgs) </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">VOID</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">    </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> e </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> Exception                   </text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">    </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> c </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> STRINGe := (Exception) args:ExceptionObject </text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">    c := &quot;</text><text style="font-weight:normal; font-style:normal; color:#000000;">发生了未处理的异常</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">&quot;+crlf</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">    c += &quot;===================================&quot;+crlf</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">    </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">DO</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">WHILE</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> e != </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">NULL</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">       c += &quot;Exception: &quot;+e:Message+crlf</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">       c += &quot;Callstack:&quot;+crlf</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">       c += e:StackTrace+crlf</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">       e := e:InnerException</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">    </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">ENDDO</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">    c += &quot;===================================&quot;+crlf      </text><br/><tab/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">MessageBox(IntPtr.Zero, c,&quot;Error&quot;,0x60010) </text><text style="font-weight:bold; font-style:italic; text-decoration:none; color:#339966;">// MB_OK + MB_ICONSTOP+ MB_DEFAULT_DESKTOP_ONLY + MB_TOPMOST</text><br/><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">[DllImport(&quot;user32.dll&quot;, CharSet := CharSet.</text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">Ansi</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">)];</text><br/><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">STATIC</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">METHOD</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> MessageBox(hwnd </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> IntPtr, lpText </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">STRING</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">, lpCaption </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">STRING</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">, uType </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">DWORD</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">) </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">INT</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">PASCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;">   </text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">END</text><text style="font-weight:normal; font-style:normal; color:#000000;"> </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">CLASS</text></para>
    <para styleclass="Normal" style="line-height:1.00; tabstops:720px left,1440px left,2160px left,2880px left,3600px left ;"></para>
    <para styleclass="Body Text">注意一点：</para>
    <para styleclass="Body Text">请勿在异常处理程序中使用或调用任何 Xbase 类型和函数，因为您无法确保运行时已正确初始化。</para>
    <para styleclass="Body Text">如果使用自己编写的类，请确保所有类都是强类型的，并且只使用本地类型。因此不要使用 USUAL、FLOAT、SYMBOL 等类型。</para>
    <para styleclass="Body Text">不要调用同一应用程序或 DLL 中函数内部的代码，因为这些函数所在类的类型初始化程序也会产生异常。</para>
  </body>
</topic>
