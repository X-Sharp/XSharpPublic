<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="../helpproject.xsl" ?>
<topic template="Default" modified="2024-07-13T03:14:14.842+08:00" lasteditedby="niuji" version="2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../helpproject.xsd">
  <title>XS9068</title>
  <keywords>
    <keyword>PSZ</keyword>
    <keyword>String2Psz()</keyword>
    <keyword>StringAlloc()</keyword>
    <keyword>XS9068</keyword>
  </keywords>
  <body>
    <header>
      <para styleclass="Heading1">Warning XS9068</para>
    </header>
    <para styleclass="Normal"></para>
    <para styleclass="Normal">编译器会自动生成 PSZ 转换。这会导致应用程序内存泄漏。请使用 String2Psz() 让编译器管理 PSZ 的生存期限，或者使用 StringAlloc() 并自行记忆 PSZ 的生存期限。</para>
    <para styleclass="Normal"></para>
    <para styleclass="Normal">这种情况可能发生在以下代码中：</para>
    <para styleclass="Code Example"><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> Start() </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">VOID</text><br/><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> uValue </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">USUAL</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">uValue := &quot;SomeString&quot;</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">? Test(uValue)</text><br/><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">? Test(</text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">PSZ</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">(</text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">_CAST</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">, &quot;AnotherString&quot;))</text><br/><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">RETURN</text><br/><br/><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> Test(p </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">PSZ</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">) </text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">STRING</text><br/><text style="font-weight:bold; font-style:normal; text-decoration:none; color:#ff0000;">RETURN</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;"> Psz2String(p)</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">编译器会检测到 Test() 函数希望接收一个 Psz()，并立即创建 USUAL 到 PSZ 的转换。如果 usual 的内容是指针，则不会分配内存。当 usual 的内容是字符串时，将分配内存，用于保存从 Unicode 转换为 Ansi 后的 PSZ。</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">编译器不知道 Test() 函数将如何处理 PSZ，因此无法控制变量的生存期限。我们建议您修改代码，使用 String2Psz() 或 StringAlloc()。</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">当然，这些函数只有在通常包含字符串的情况下才会起作用，如上例所示。</text></para>
    <para styleclass="Code Example"><text style="font-weight:bold; font-style:normal; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Start() </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">VOID</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> uValue </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">USUAL</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">uValue := &quot;SomeString&quot;</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">? Test(String2Psz(uValue))</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">? Test(String2Psz(</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">&quot;AnotherString&quot;</text><text style="font-weight:normal; font-style:normal; color:#000000;">))</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">RETURN</text><br/><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Test(p </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">PSZ</text><text style="font-weight:normal; font-style:normal; color:#000000;">) </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">STRING</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">RETURN</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Psz2String(p)</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">或者</text></para>
    <para styleclass="Code Example"><text style="font-weight:bold; font-style:normal; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Start() </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">VOID</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> uValue </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">USUAL</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">LOCAL</text><text style="font-weight:normal; font-style:normal; color:#000000;"> p </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">as</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">PSZ</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">uValue := &quot;SomeString&quot;</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">p := StringAlloc(uValue)</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">? Test(p)</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">MemFree(p)</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">p := StringAlloc(</text><text style="font-weight:normal; font-style:normal; text-decoration:none; color:#000000;">&quot;AnotherString&quot;</text><text style="font-weight:normal; font-style:normal; color:#000000;">)</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">? Test(p)</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">MemFree(p)</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">RETURN</text><br/><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">FUNCTION</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Test(p </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">PSZ</text><text style="font-weight:normal; font-style:normal; color:#000000;">) </text><text style="font-weight:bold; font-style:normal; color:#ff0000;">AS</text><text style="font-weight:normal; font-style:normal; color:#000000;">&#32;</text><text style="font-weight:bold; font-style:normal; color:#ff0000;">STRING</text><br/><text style="font-weight:bold; font-style:normal; color:#ff0000;">RETURN</text><text style="font-weight:normal; font-style:normal; color:#000000;"> Psz2String(p)</text><br/></para>
  </body>
</topic>
