//
// Copyright (c) XSharp B.V.  All Rights Reserved.  
// Licensed under the Apache License, Version 2.0.  
// See License.txt in the project root for license information.
//
USING System
USING System.Collections.Generic
USING System.Linq
USING System.Text
USING XUnit
USING System.Globalization

BEGIN NAMESPACE XSharp.VO.Tests

	CLASS DbfCdxTests

		[Fact, Trait("Category", "DBFFuncs")];
		METHOD DBCreate_Tests() AS VOID
			LOCAL aFields AS ARRAY
			aFields := {{"TEST","C",10,0}}
	
			LOCAL cFileName_WithExt AS STRING
			LOCAL cFileName_NoExt AS STRING
			cFileName_NoExt := "DBCreate_Tests"
			cFileName_WithExt := cFileName_NoExt + ".dbf"
			IF System.IO.File.Exists(cFileName_WithExt)
				System.IO.File.Delete(cFileName_WithExt)
			END IF
			Assert.True(  DbCreate(cFileName_NoExt , aFields , "DBFCDX")  )
			Assert.True(  System.IO.File.Exists(cFileName_WithExt) )
			
			IF System.IO.File.Exists(cFileName_WithExt)
				System.IO.File.Delete(cFileName_WithExt)
			END IF
			Assert.True(  DbCreate(cFileName_WithExt , aFields , "DBFCDX")  )
			Assert.True(  System.IO.File.Exists(cFileName_WithExt) )
	
			cFileName_WithExt := cFileName_NoExt + ".none"
			IF System.IO.File.Exists(cFileName_WithExt)
				System.IO.File.Delete(cFileName_WithExt)
			END IF
			Assert.True(  DbCreate(cFileName_WithExt , aFields , "DBFCDX")  )
			Assert.True(  System.IO.File.Exists(cFileName_WithExt) )
		RETURN
	
		[Fact, Trait("Category", "DBFFuncs")];
		METHOD DBAppend_Exclusive() AS VOID
			LOCAL aFields AS ARRAY
			LOCAL cFileName AS STRING
			aFields := {{"TEST","C",10,0}}
			cFileName := "DBAppend_Exclusive"
	
			Assert.True(  DbCreate(cFileName , aFields , "DBFCDX")  )
			Assert.True(  DbUseArea(,"DBFCDX",cFileName,,FALSE) )
			Assert.True(  RecCount() == 0 )
			Assert.True(  DbAppend() )
			FieldPut(1 , "test")
			Assert.True(  AllTrim(FieldGet(1)) == "test" )
			Assert.True(  DbCloseArea() )
		RETURN
	
		[Fact, Trait("Category", "DBFFuncs")];
		METHOD DBAppend_Shared() AS VOID
			LOCAL aFields AS ARRAY
			LOCAL cFileName AS STRING
			aFields := {{"TEST","C",10,0}}
			cFileName := "DBAppend_Shared"
	
			Assert.True(  DbCreate(cFileName , aFields , "DBFCDX")  )
			Assert.True(  DbUseArea(,"DBFCDX",cFileName,,TRUE) )
			Assert.True(  RecCount() == 0 )
			Assert.True(  DbAppend() )
			FieldPut(1 , "test")
			Assert.True(  AllTrim(FieldGet(1)) == "test" )
			Assert.True(  DbCloseArea() )
		RETURN
	
		[Fact, Trait("Category", "DBFFuncs")];
		METHOD DBAppend_more() AS VOID
		LOCAL cDbf AS STRING
			cDbf := "testappend.DbF"
			RddSetDefault( "DBFCDX" )
			Assert.True(  DbCreate(cDbf , { {"TEST","C",10,0} }) )
			// Appending in exclusive mode:
			Assert.True( DbUseArea(, , cDbf , "alias1" , FALSE) )
			Assert.True( DbAppend() )
			Assert.True( RecCount() == 1 )
			FieldPut(1, "test") // ok
			Assert.True( AllTrim(FieldGet(1)) == "test" )
			Assert.True( DbCloseArea() )
	
			// Appending in SHARED mode:
			Assert.True( DbUseArea(, , cDbf , "alias2" , TRUE) )
			Assert.True( RecCount() == 1 )
			Assert.True( DbAppend() )// returns true but does not append record
			Assert.True( RecCount() == 2 )
			FieldPut(1, "test2") // ok
			Assert.True( AllTrim(FieldGet(1)) == "test2" )
			Assert.True( DbCloseArea() )
		RETURN
	
		[Fact, Trait("Category", "DBFFuncs")];
		METHOD DBUseArea_same_file_twice() AS VOID
		LOCAL cDbf AS STRING
			RddSetDefault( "DBFCDX" )
			cDbf := "testtwice.DbF"
			Assert.True(  DbCreate(cDbf , { {"TEST","C",10,0} }) )
	
			// shared mode
			Assert.True( DbUseArea(, , cDbf , , FALSE) )
			Assert.True( DbCloseArea() )
	
			Assert.True( DbUseArea(, , cDbf , , FALSE) )
			Assert.True( DbCloseArea() )
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD VODBInfo() AS VOID
			
			LOCAL cFileName AS STRING
			cFileName := GetTempFileName("test")
			FErase(cFileName + ".cdx")

			RddSetDefault("DBFCDX")

			DbCreate(cFileName , { {"CFIELD","C",10,0} })
			DbUseArea(,,cFileName)
			DbAppend()
			
			LOCAL u AS USUAL
			VoDbSkip(-1)
			
			VoDbInfo(DBI_FULLPATH , REF u)
			LOCAL c AS STRING
			c := u
			? c
			Assert.True(c:EndsWith("test.DBF") .AND. c:Contains(":\"))
			VoDbInfo(DBI_DB_VERSION , REF u)
			Assert.True(SLen(u) > 1)
			VoDbInfo(DBI_ALIAS , REF u)
			Assert.Equal("test" , u)
			
			VoDbInfo(DBI_BOF , REF u)
			Assert.Equal(TRUE , (LOGIC) u)
			VoDbInfo(DBI_EOF , REF u)
			Assert.Equal(FALSE ,(LOGIC)  u)
			VoDbInfo(DBI_ISANSI , REF u)
			Assert.Equal(SetAnsi() ,(LOGIC)  u)
			VoDbInfo(DBI_FCOUNT , REF u)
			Assert.Equal(1, (LONG)  u)
			VoDbInfo(DBI_READONLY , REF u)
			Assert.Equal(FALSE,(LOGIC)  u)
			
			DbCloseArea()
		RETURN

		[Fact, Trait("Category", "DBF")];
		METHOD AppendShared() AS VOID
			LOCAL cDbf AS STRING
			cDbf := GetTempFileName("testAppendShared")
			FErase(cDbf + ".cdx")

			RddSetDefault( "DBFCDX" )
			DbCreate(cDbf , { {"TEST","C",10,0} })
			
//			Appending in exclusive mode:
			DbUseArea(, , cDbf , "alias2" , FALSE)
			Assert.True( DbAppend() )
			Assert.Equal( 1 , RecCount() )
			FieldPut(1, "test") // ok
			DbCloseArea()
			
//			Appending in SHARED mode:
			DbUseArea(, , cDbf , "alias2" , TRUE)
			Assert.True( DbAppend() ) // returns true but does not append record
			Assert.Equal( 2 , RecCount() ) // returns 1, wrong
			DbCloseArea()
		RETURN

		[Fact, Trait("Category", "DBF")];
		METHOD AliasNameReuse() AS VOID
			LOCAL cDbf AS STRING
			cDbf := GetTempFileName("testdbf")
			FErase(cDbf + ".cdx")
			
			RddSetDefault( "DBFCDX" )
			
			DbCreate(cDbf , { {"TEST","C",10,0} })
			
//			opening and closing once
			DbUseArea(, , cDbf , , FALSE)
			DbCloseArea()
			
//			opening and closing again
			Assert.True( DbUseArea(, , cDbf , , FALSE) )
			Assert.True( DbCloseArea() )
		RETURN

		[Fact, Trait("Category", "DBF")];
		METHOD SavingDecimalValues() AS VOID
			LOCAL cFileName AS STRING
			cFileName := GetTempFileName()
			FErase(cFileName + ".cdx")

			RddSetDefault("DBFCDX")

			DbCreate(cFileName, {{"FLD1","N",10,2},{"FLD2","N",10,0}})
			DbUseArea(,,cFileName)
			DbAppend()

			SetDecimalSep(Asc(","))
			FieldPut(1 , 12.34) // not saved in the dbf
			Assert.Equal(12.34 , (FLOAT) FieldGet(1)) // 0,00

			SetDecimalSep(Asc("."))
			FieldPut(1 , 12.34)
			Assert.Equal(12.34 , (FLOAT) FieldGet(1))

			DbCloseArea()
		RETURN

		[Fact, Trait("Category", "DBF")];
		METHOD DBCommitAfterFieldput() AS VOID
			LOCAL cFileName AS STRING
			cFileName := GetTempFileName()
			FErase(cFileName + ".cdx")

			RddSetDefault("DBFCDX")

			DbCreate(cFileName, {{"FLD1","N",10,4}})
			DbUseArea( , , cFileName , "tempalias")
			DbAppend()
			DbCloseArea()
			
			DbUseArea( , , cFileName)
			FieldPut(1 , FLOAT{46.11}) // ! a float isn/t stored !
			DbCommit()
			Assert.Equal(46.11 , (FLOAT) FieldGet(1)) // runtime exception
			DbCloseArea()
		RETURN
	
	
		[Fact, Trait("Category", "DBF")];
		METHOD FieldNameSym() AS VOID
			LOCAL cFileName AS STRING
			cFileName := GetTempFileName()
			FErase(cFileName + ".cdx")

			RddSetDefault("DBFCDX")

			DbCreate(cFileName, {{"FLD1","N",10,4}})
			DbUseArea( , , cFileName , "tempalias")
			DbAppend()
			Assert.Equal("", FieldName(100)) // exception
			Assert.Equal("", FieldName(0))
			Assert.Equal(NULL_SYMBOL, FieldSym(100))
			Assert.Equal(NULL_SYMBOL, FieldSym(0))
			DbCloseArea()
		RETURN
	
	
	
		[Fact, Trait("Category", "DBF")];
		METHOD DBRLockList() AS VOID
			LOCAL cFileName AS STRING
			cFileName := GetTempFileName()
			FErase(cFileName + ".cdx")

			RddSetDefault("DBFCDX")

			DbCreate(cFileName, {{"FLD1","C",10,0}})
			DbUseArea( , , cFileName , "tempalias" , TRUE)
			DbAppend()
			DbAppend()
			DbGoTop()
			DbRLock()
			DbRLockList()
			Assert.Equal(1, (INT) ALen(DbRLockList()))
			Assert.Equal(1, (INT) DbRLockList()[1])
			DbUnLock()
			DbSkip()
			DbRLock()
			Assert.Equal(1, (INT)  ALen(DbRLockList()))
			Assert.Equal(2, (INT) DbRLockList()[1])
			DbCloseArea()
		RETURN
	
		[Fact, Trait("Category", "DBF")];
		METHOD DBFilter() AS VOID
			LOCAL cDbf AS STRING
			cDbf := __FUNCTION__
			FErase(cDbf + ".cdx")

			RddSetDefault("DBFCDX")

			IF System.IO.File.Exists(cDbf)
				System.IO.File.Delete(cDbf)
			END IF
			DbCreate(cDbf, {{"CFIELD","C",10,0}}, "DBFCDX", TRUE)
			DbAppend()
			FieldPut(1, "ABC")
			DbAppend()
			FieldPut(1, "DEF")
			DbAppend()
			FieldPut(1, "GHI")
			DbAppend()
			FieldPut(1, "JKL")
			Assert.Equal(4 , (INT) RecCount())
			Assert.Equal(4 , (INT) LastRec())
			DbCloseArea()
						
			DbUseArea(,,cDbf)
//			"Setting filter to GHI, should be one record:"
//			"Instead, record 1 and 3 are shown"
			DbSetFilter({||AllTrim(FIELD->CFIELD) == "GHI"})
			DbGoTop()
			LOCAL nCount := 0 AS INT
			DO WHILE .NOT. EoF()
				Assert.Equal(3 , (INT) RecNo())
				FieldGet(1)
				DbSkip(+1)
				nCount ++
			END DO
			Assert.Equal(1 , nCount)
			
			DbGoBottom()
			Assert.False( Eof() )
			nCount := 0
			DO WHILE .NOT. EoF()
				Assert.Equal(3 , (INT) RecNo())
				nCount ++
				FieldGet(1)
				DbSkip(+1)
			END DO
			Assert.Equal(1 , nCount)
			
			DbCloseArea()
		RETURN

		[Fact, Trait("Category", "DBF")];
		METHOD DBRecordInfo_test() AS VOID
			LOCAL cDbf AS STRING
			LOCAL l AS LOGIC
			cDbf := GetTempFileName()
			FErase(cDbf + ".cdx")
			
			DbCreate(cDbf, {{"CFIELD","C",10,0}}, "DBFCDX", TRUE)
			DbAppend()
			FieldPut(1, "ABC")
			
			l := DbRecordInfo( DBRI_RECNO ) // exception
			Assert.True(l)
			l := DbRecordInfo( DBRI_DELETED ) // exception
			Assert.False(l)
			l := DbRecordInfo( DBRI_LOCKED ) // exception
			Assert.True(l)
			
			DbCloseArea()
		RETURN
		
		[Fact, Trait("Category", "DBF")];
		METHOD DBFieldInfo_test() AS VOID
			LOCAL cDbf AS STRING
			cDbf := __FUNCTION__
			FErase(cDbf + ".cdx")
			
			DbCreate(cDbf, {{"NFIELD","N",10,3}}, "DBFCDX", TRUE)
			DbAppend()
			FieldPut(1, 1.23)
			
			Assert.Equal("NFIELD",	DbFieldInfo( DBS_NAME , 1 ) ) // NullReferenceException
			Assert.Equal("N",		DbFieldInfo( DBS_TYPE , 1 ) )
			Assert.Equal(10,		(INT) DbFieldInfo( DBS_LEN , 1 ) )
			Assert.Equal(3,			(INT) DbFieldInfo( DBS_DEC , 1 ) )
			Assert.Equal(5,			(INT) DbFieldInfo( DBS_PROPERTIES , 1 ) )
			
			DbCloseArea()
		RETURN

		[Fact, Trait("Category", "DBF")];
		METHOD DBRecordInfo_test2() AS VOID
			LOCAL cDbf AS STRING
			cDbf := __FUNCTION__
			FErase(cDbf + ".cdx")
			
			DbCreate(cDbf, {{"CFIELD","C",10,0}}, "DBFCDX", TRUE)
			DbAppend()
			FieldPut(1, "ABC")
			DbAppend()
			FieldPut(1, "DEF")
			
			DbGoTop()
			Assert.Equal(1, (INT) RecNo())
			Assert.Equal(FALSE, Eof())
			
//			 Any of the below cause the record pointer to go EOF
			Assert.False( DbRecordInfo(DBRI_DELETED , 0) )
			DbRecordInfo(DBRI_BUFFPTR , 0)
			DbRecordInfo(DBRI_RAWDATA , 0)
			
			Assert.Equal(1, (INT) RecNo())
			Assert.Equal(FALSE, Eof())
			
			DbCloseArea()
		RETURN
	
		[Fact, Trait("Category", "DBF")];
		METHOD DBContinue_test() AS VOID
			LOCAL cDbf AS STRING
			cDbf := __FUNCTION__
			FErase(cDbf + ".cdx")

			RddSetDefault("DBFCDX")

			DbCreate(cDbf, {{"NFIELD","N",10,0}}, "DBFCDX", TRUE)
			DbAppend()
			FieldPut(1, 123)
			DbAppend()
			FieldPut(1, 456)
			DbAppend()
			FieldPut(1, 789)
			
			DbGoTop()
			Assert.True( DbLocate({||_FIELD->NFIELD > 300} , , , , TRUE) ) // DBSCOPEREST
			Assert.True( Found() )
			Assert.Equal(456.0 , (FLOAT)  FieldGet(1) )
			
//			DBContinue() returns TRUE (correct) but does not move record pointer at all
			Assert.True( DbContinue() )
			Assert.True( Found() )
			Assert.Equal( 789.0 , (FLOAT)  FieldGet(1) )
			
			Assert.True( DbContinue() )
			Assert.False( Found() )
			Assert.Equal( 0.0 , (FLOAT) FieldGet(1) )
			
			Assert.True( DbContinue() )
			Assert.False( Found() )
			Assert.Equal( 0.0 , (FLOAT) FieldGet(1) )
			
			DbCloseArea()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD DBAppendWithNoWorkarea() AS VOID
			RddSetDefault("DBFCDX")

			DbCloseAll()
			Assert.False( DbAppend() )
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD Shared_Cdx() AS VOID
			Shared_Cdx_helper(TRUE)
			Shared_Cdx_helper(FALSE)
		RETURN
		PRIVATE METHOD Shared_Cdx_helper(lUseIndexFormVO AS LOGIC) AS VOID
			LOCAL cDbf AS STRING
			LOCAL cCdx AS STRING
            RddSetDefault("DBFCDX")
			cDbf := GetTempFileName("testcdx")
			cCdx := cDbf + ".cdx"
            FErase(cCdx)
			
			Assert.True( DbCreate( cDbf , {{"CFIELD" , "C" , 10 , 0 }}) )
			Assert.True( DbUseArea(,,cDbf,,FALSE) )
			Assert.True( DbAppend() )
			FieldPut ( 1 , "B")
			Assert.True( DbAppend() )
			FieldPut ( 1 , "A")
			Assert.True( DbCloseArea() )
			
			IF lUseIndexFormVO
				System.IO.File.WriteAllBytes(cCdx , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAQD//////////94B//8AAA8PEAQEAwAGMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABURVNUQ0RYAAoAAAAAAAAAAAAACgBgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwABAAAABwBDRklFTEQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAgD//////////+AB//8AAA8PEAQEAwIAkAEAkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEJB"))
			ELSE
				Assert.True( DbUseArea(,,cDbf,,TRUE) ) // ----- opening in SHARED mode
				Assert.True( DbCreateIndex(cCdx , "CFIELD") ) // returns TRUE
				Assert.True( DbCloseArea() )
			END IF
			
			Assert.True( DbUseArea(,,cDbf,,FALSE) )
			Assert.True( DbSetIndex(cCdx) )
			DbGoTop()
			Assert.True( AllTrim(FieldGet(1)) == "A" )
			DbGoBottom()
			Assert.True( AllTrim(FieldGet(1)) == "B" )
			Assert.True( DbCloseArea() ) // XSharp.RDD.RddError here
			
            Assert.True( FErase(cDbf + ".dbf") )
            Assert.True( FErase(cCdx) ) // false if still in use
			
		RETURN

		[Fact, Trait("Category", "DBF")];
		METHOD Save_NULL_DATE() AS VOID
			LOCAL cDbf AS STRING
			cDbf := GetTempFileName()
			FErase(cDbf + ".cdx")

			RddSetDefault("DBFCDX")

			Assert.True(  DbCreate( cDbf , {{"CFIELD" , "C" , 10 , 0 },;
			{"DFIELD" , "D" , 8 , 0 }}) )
			Assert.True( DbUseArea(,,cDbf) )
			DbAppend()
			FieldPut ( 1 , "B")
			DbAppend()
			FieldPut ( 1 , "A")
			Assert.True( DbCloseArea() )
			
			Assert.True( DbUseArea(,,cDbf) )
			LOCAL u AS USUAL
			u := FieldGet(2) // it should be a NULL_DATE
			Assert.True( u == NULL_DATE )
			FieldPut(2,u) // exception
			FieldPut(2,NULL_DATE) // exception
			Assert.True( FieldGet(2) == NULL_DATE )
			Assert.True(  DbCloseArea() )
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD Cdx_Issues() AS VOID
			Cdx_Issues_Helper(TRUE)
			Cdx_Issues_Helper(FALSE)
		RETURN
		PRIVATE METHOD Cdx_Issues_Helper(lUseIndexFormVO AS LOGIC) AS VOID
			LOCAL cDbf AS STRING
			LOCAL cCdx AS STRING
			LOCAL aResult AS ARRAY
			
			RddSetDefault("DBFCDX")
			
			cDbf := GetTempFileName("testcdx1"+IIF(lUseIndexFormVO, "V","X"))
			cCdx := cDbf + ".cdx"
			FErase(cCdx)
			
			DbCreate( cDbf , {{"CFIELD" , "C" , 10 , 0 }} , "DBFCDX")
			DbUseArea(,,cDbf)
			DbAppend()
			FieldPut ( 1 , "ABC")
			DbAppend()
			FieldPut ( 1 , "GHI")
			DbAppend()
			FieldPut ( 1 , "DEF")
			DbAppend()
			FieldPut ( 1 , "K")
			DbCloseArea()
			
			IF lUseIndexFormVO
				System.IO.File.WriteAllBytes(cCdx , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAQD//////////90B//8AAA8PEAQEAwAGIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRFU1RDRFgxAAoAAAAAAAAAAAAACgBgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwABAAAABwBDRklFTEQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMABAD//////////9IB//8AAA8PEAQEAwEAcAMAcAIAcAQAkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABLR0hJREVGQUJD"))
			ELSE
				Assert.True( DbUseArea(,,cDbf) )
				Assert.True( DbCreateIndex(cCdx , "CFIELD") )
				Assert.True( DbCloseArea() )
			END IF
			
			Assert.True( DbUseArea(,,cDbf,,FALSE) )
//			Assert.True( DBSetIndex(cCdx) )
			Assert.True( DbSetOrder(1) )
			
			aResult := GetRecords()
//			should be ABC, DEF, GHI, K
			Assert.True( aResult[1] == "ABC")
			Assert.True( aResult[2] == "DEF")
			Assert.True( aResult[3] == "GHI")
			Assert.True( aResult[4] == "K")
			
			DbGoTop()
			DbSkip()
			FieldPut(1,"HHH")
			aResult := GetRecords()
//			should be ABC, GHI, HHH, K, because the record has been moved in the index
			Assert.True( aResult[1] == "ABC")
			Assert.True( aResult[2] == "GHI")
			Assert.True( aResult[3] == "HHH")
			Assert.True( aResult[4] == "K")

			DbGoTop()
			DbSkip(2)
			FieldPut(1,"DEF") // restore it
			
			Assert.True( DbCloseArea() )


			Assert.True( DbUseArea(,,cDbf,,TRUE) )
			Assert.True( DbSetIndex(cCdx) )
			aResult := GetRecords()
//			should be ABC, DEF, GHI, K
			Assert.True( aResult[1] == "ABC")
			Assert.True( aResult[2] == "DEF")
			Assert.True( aResult[3] == "GHI")
			Assert.True( aResult[4] == "K")
			
			DbGoTop()
			DbSkip()
			Assert.True(RLock())
			FieldPut(1,"III")
			aResult := GetRecords()
//			should be ABC, GHI, III, K
			Assert.True( aResult[1] == "ABC")
			Assert.True( aResult[2] == "GHI")
			Assert.True( aResult[3] == "III")
			Assert.True( aResult[4] == "K")
			
			Assert.True( DbCloseArea() )
		RETURN

		PRIVATE STATIC METHOD GetRecords() AS ARRAY
			LOCAL aResult AS ARRAY
			aResult := {}
			DbGoTop()
			DO WHILE .NOT. Eof()
				AAdd(aResult , AllTrim(FieldGet(1)))
				DbSkip()
			END DO
		RETURN aResult

		[Fact, Trait("Category", "DBF")];
		METHOD Cdx_Issues2() AS VOID
			Cdx_Issues2_helper(TRUE)
			Cdx_Issues2_helper(FALSE)
		RETURN
		PRIVATE METHOD Cdx_Issues2_helper(lUseIndexFormVO AS LOGIC) AS VOID
			LOCAL cFileName AS STRING
			LOCAL cCdx AS STRING
			cFileName := GetTempFileName("testcdx")
			cCdx := cFileName + ".cdx"
			FErase(cCdx)

			RddSetDefault("DBFCDX")

			DbCreate(cFileName, {{"FLD1","C",10,0},{"FLD2","N",10,0}})
			DbUseArea( , , cFileName , , FALSE)
			FOR LOCAL n := 1 AS INT UPTO 10
				DbAppend()
				FieldPut(1, n:ToString())
				FieldPut(2, n)
			NEXT
			IF lUseIndexFormVO
				Assert.True( DbCloseArea() )
				System.IO.File.WriteAllBytes(cCdx , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAQD//////////90B//8AAA8PEAQEAwAGIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRFU1RDRFgyAAoAAAAAAAAAAAAACABgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQABAAAABQBGTEQyAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMACgD//////////78B//8AAA8PEAQEAwEAYAIAcAMAYQQAYQUAYQYAYQcAYQgAYQkAYQoAYQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACQiIBwYFBAIwL/w"))
			ELSE
				Assert.True( DbCreateIndex(cCdx , "FLD2") )
				Assert.True( DbCloseArea() )
			END IF

			DbUseArea( , , cFileName , , FALSE)
//			Assert.True( DBSetIndex(cCdx) )
			Assert.True( DbSetOrder(1) )
			DbGoTop()
			LOCAL nCount := 0 AS INT
			DO WHILE ! Eof()
				nCount ++
				Assert.True( FieldGet(2) == RecNo() )
				Assert.True( FieldGet(2) == nCount )
				Assert.True( DbSkip() )
			END DO
			Assert.True( DbCloseArea() )
		RETURN

		[Fact, Trait("Category", "DBF")];
		METHOD WorkareaNums() AS VOID
			LOCAL cFileName AS STRING
			cFileName := GetTempFileName()
			FErase(cFileName + ".cdx")

			RddSetDefault("DBFCDX")

			Assert.True( DbCreate(cFileName, {{"FLD1","C",10,0}}) )
			
			Assert.True( DbUseArea ( TRUE , , cFileName , "a1") )
			Assert.Equal( 1u , DbGetSelect() )
			Assert.True( DbCloseArea() )
			
			Assert.True( DbUseArea ( TRUE , , cFileName , "a2") )
			Assert.Equal( 1u , DbGetSelect() )
			Assert.True( DbCloseArea() )
			
			Assert.True( DbUseArea ( TRUE , , cFileName , "a3") )
			Assert.Equal( 1u , DbGetSelect() )
			Assert.True( DbCloseArea() )
		RETURN

		// FOX-ES1QLR6Y5L , dbRecordInfo ( DBRI_LOCKED ) always returns .f.
		[Fact, Trait("Category", "DBF")];
		METHOD DBRI_LOCKED_test() AS VOID
			LOCAL cFileName AS STRING
			cFileName := GetTempFileName()
			FErase(cFileName + ".cdx")

			RddSetDefault("DBFCDX")
            TRY
			SetExclusive ( FALSE )
			DbCreate ( cFileName , { {"id", "C", 5, 0} })
		
			DbUseArea ( , , cFileName )
			DbAppend()
			DbAppend()
			DbAppend()
			DbGoTop()
			
			Assert.True( DbRLock ( RecNo() ) )
			Assert.True( DbRecordInfo ( DBRI_LOCKED ) ) // Should show TRUE
			Assert.True( AScan ( DbRLockList() , RecNo() ) > 0 )
			
			DbSkip()
//			record 2 - no lock
			Assert.False( DbRecordInfo ( DBRI_LOCKED ) )
			Assert.False( AScan ( DbRLockList() , RecNo() ) > 0 )
			
			DbSkip()
			Assert.True( DbRLock ( RecNo() ) )
			Assert.True( DbRecordInfo ( DBRI_LOCKED ) ) // Should show TRUE
			Assert.True( AScan ( DbRLockList() , RecNo() ) > 0 )
			
			LOCAL a AS ARRAY
			a:= DbRLockList()
			Assert.Equal( 2 , (INT) ALen(a) )
			Assert.Equal( 1 , (INT) a[1] )
			Assert.Equal( 3 , (INT) a[2] )

            FINALLY
			DbCloseArea()
			
			SetExclusive ( TRUE ) // restore
            END TRY
		RETURN

		[Fact, Trait("Category", "DBF")];
		METHOD Alias_test() AS VOID

			RddSetDefault("DBFCDX")

			DbCloseAll()
			Assert.True( Alias() == "" )
			Assert.True( Alias0() == "" )
			Assert.True( Alias0Sym() == "" )
		RETURN

		[Fact, Trait("Category", "DBF")];
		METHOD DBCreate_test() AS VOID
			LOCAL cFileName AS STRING
			cFileName := GetTempFileName()
			FErase(cFileName + ".cdx")
			
			RddSetDefault("DBFCDX")

			DbCreate(cFileName, {{"FLD1","C",10,0}})
			DbUseArea(,,cFileName,,FALSE)
			DbCloseArea()

//			exception here
			Assert.True( DbCreate(cFileName, {{"FLD1","N",10,0}}) )
			
			Assert.True( DbUseArea(,,cFileName) )
			DbAppend()
			FieldPut(1 , 123)
			Assert.True( FieldGet(1) == 123 )
			Assert.True( DbCloseArea() )
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD DBError_test() AS VOID
			LOCAL cDbf AS STRING
			
			RddSetDefault("DBFCDX")

			cDbf := GetTempFileName()
			FErase(cDbf + ".cdx")
			
			DbCreate( cDbf , {{"CFIELD" , "C" , 10 , 0 }})
			DbUseArea(,,cDbf,,TRUE)
			Assert.True( DbAppend() )
			Assert.True( DbUnLock() )
			TRY
				? FieldPut ( 1 , "ABC") // record not locked
			CATCH e AS XSharp.Error
				? e:Message
				? e:GenCodeText
				? e:SubCodeText // check if this displays correctly
				? e:OSCodeText
				? e:ToString() // exception here
			FINALLY
				Assert.True( DbCloseArea() )
			END TRY
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD Cdx_Eof_test() AS VOID
			Cdx_Eof_test_helper(TRUE)
			Cdx_Eof_test_helper(FALSE)
		RETURN
		PRIVATE METHOD Cdx_Eof_test_helper(lUseIndexFormVO AS LOGIC) AS VOID
			LOCAL cDbf AS STRING
			LOCAL cCdx AS STRING
			
			RddSetDefault("DBFCDX")

			cDbf := GetTempFileName("testcdx")
			cCdx := cDbf + ".cdx"
			FErase(cCdx)
			
			DbCreate( cDbf , {{"NFIELD" , "N" , 5 , 0 }})
			DbUseArea(,,cDbf,,FALSE)
			DbAppend()
			FieldPut(1,123)
			DbAppend()
			FieldPut(1,456)
			IF lUseIndexFormVO
				DbCloseArea()
				System.IO.File.WriteAllBytes(cCdx , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAQD//////////90B//8AAA8PEAQEAwAGIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRFU1RDRFgzAAoAAAAAAAAAAAAACABgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwABAAAABwBORklFTEQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAgD//////////90B//8AAA8PEAQEAwEAUAIAUQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHyAwF7A"))
			ELSE
				DbCreateIndex(cCdx, "NFIELD")
				DbCloseArea()
			END IF
			

			// necessary sequence to reproduce the problem below
			DbUseArea(,,cDbf,,FALSE)
//			DBSetIndex(cCdx)
			DbSetOrder(1)
			DbGoTop()
			Assert.Equal(1, (INT)RecNo()) // 1
			DbGoBottom()
			Assert.Equal(2, (INT)RecNo()) // 2
			DbSkip(-1)
			Assert.Equal(1, (INT)RecNo()) // 1
			DbGoto(2)
			Assert.Equal(2, (INT)RecNo()) // 2


			DbSkip(+1)
			Assert.Equal(TRUE, (LOGIC)Eof()) // FALSE, wrong
			Assert.Equal(3, (INT)RecNo()) // 2, wrong

			DbSkip(+1)
			Assert.Equal(TRUE, (LOGIC)Eof()) // TRUE
			Assert.Equal(3, (INT)RecNo()) // 3

			DbCloseArea()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD DBOrderInfo_DBOI_SETCODEBLOCK() AS VOID
			LOCAL cDBF, cCDX AS STRING
			
			RddSetDefault("DBFCDX")

			cDBF := GetTempFileName("test")
			cCDX := cDBF + ".cdx"
			FErase(cCdx)
			
			DbCreate( cDBF , {{"ID" , "C" , 5 , 0 }})
			DbUseArea(,,cDBF)
			
			DbAppend()
			FieldPut(1, "one")
			
			DbCreateIndex(cCDX , "Upper (ID)")
			DbCloseArea()
			
			DbUseArea(,,cDBF)
			DbSetIndex(cCDX)
			
			? "DBOI_SETCODEBLOCK" , DbOrderInfo( DBOI_SETCODEBLOCK )
			
			DbCloseArea()		
		RETURN

		
		[Fact, Trait("Category", "DBF")];
		METHOD OrdScope_test() AS VOID
			OrdScope_test_helper(TRUE)
			OrdScope_test_helper(FALSE)
		RETURN
		PRIVATE METHOD OrdScope_test_helper(lUseIndexFormVO AS LOGIC) AS VOID
			LOCAL cDbf AS STRING
			LOCAL cCdx AS STRING
			cDbf := GetTempFileName("testcdx")
			cCdx := cDbf + ".cdx"
			FErase(cCdx)

			RddSetDefault("DBFCDX")

			DbCreate( cDbf , {{"NFIELD" , "N" , 5 , 0 }})
			DbUseArea(,"DBFCDX",cDbf)
			FOR LOCAL n := 1 AS INT UPTO 20
				DbAppend()
				FieldPut(1,n)
			NEXT
			IF lUseIndexFormVO
				System.IO.File.WriteAllBytes(cCdx , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAQD//////////90B//8AAA8PEAQEAwAGIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRFU1RDRFg0AAoAAAAAAAAAAAAACABgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwABAAAABwBORklFTEQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAFAD//////////5cB//8AAA8PEAQEAwEAYAIAcAMAYQQAYQUAYQYAYQcAYQgAYQkAYQoAYQsAYQwAYQ0AYQ4AYQ8AYRAAYREAYRIAYRMAYRQAYQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANDMyMTAuLCooJiQiIBwYFBAIwL/w"))
			ELSE
				DbCreateIndex(cDbf , "NFIELD")
			END IF
			DbCloseArea()
			
			DbUseArea(,"DBFCDX",cDbf) // 20 records
//			DBSetIndex ( cDbf )
			DbSetOrder(1)
			Assert.Equal( (INT) DbOrderInfo( DBOI_KEYCOUNT ) , 20)
			Assert.Equal( (INT) OrdScope(TOPSCOPE, 5) , 5) // NULL
			Assert.Equal( (INT) OrdScope(BOTTOMSCOPE, 10) , 10) // NULL
			DbGoTop()
			
			Assert.Equal( (INT) DbOrderInfo( DBOI_KEYCOUNT ) , 6) // still 20 - but must be 6
			LOCAL nCount := 0 AS INT
			DO WHILE ! Eof() // all 20 records are listed
				? FieldGet ( 1 )
				DbSkip ( 1 )
				nCount ++
			ENDDO
			Assert.Equal( 6 , nCount)
			Assert.Equal( 5 , (INT) DbOrderInfo( DBOI_SCOPETOP ) ) // {(0x0000)0x00000000} CLASS
			Assert.Equal( 10 , (INT) DbOrderInfo( DBOI_SCOPEBOTTOM ) ) // {(0x0000)0x00000000} CLASS
			DbCloseArea()
		RETURN
		

		[Fact, Trait("Category", "DBF")];
		METHOD OrdScope_test_with_Ordinal_Collation() AS VOID
			LOCAL cDbf AS STRING
			cDbf := GetTempFileName()
			FErase(cDbf + ".cdx")
			
			RddSetDefault("DBFCDX")

			LOCAL uCollation AS USUAL
			uCollation := SetCollation(#ORDINAL)
			
			DbCreate( cDbf, {{"NFIELD" , "N" , 5 , 0 }})
			DbUseArea(,"DBFCDX",cDbf)
			FOR LOCAL n := 1 AS INT UPTO 20
				DbAppend()
				FieldPut(1,n)
			NEXT
			DbCreateIndex(cDbf + ".cdx" , "NFIELD")
			DbCloseArea()
			
			DbUseArea(,"DBFCDX",cDbf)
			DbSetIndex ( cDbf + ".cdx" )
			Assert.Equal( (INT) DbOrderInfo( DBOI_KEYCOUNT ) , 20)
			Assert.Equal( (INT) UsualType( DbOrderInfo( DBOI_KEYCOUNT )  ) , 1) // first time returns 6
			Assert.Equal( (INT) UsualType( DbOrderInfo( DBOI_KEYCOUNT )  ) , 1) // second time it returns 1 correctly
			DbCloseArea()
			
			SetCollation(uCollation)
		RETURN
		
		[Fact, Trait("Category", "DBF")];
		METHOD CDX_index_without_extension() AS VOID
			LOCAL cDbf AS STRING
			cDbf := "noextension"
			FErase(cDbf + ".cdx")
			FErase(cDbf)
			
			RddSetDefault("DBFCDX")
			
			DbCreate( cDbf , {{"NFIELD" , "N" , 5 , 0 }})
			DbUseArea(,"DBFCDX",cDbf)
			FOR LOCAL n := 1 AS INT UPTO 20
				DbAppend()
				FieldPut(1,n)
			NEXT
			DbCreateIndex(cDbf , "NFIELD")
			Assert.True( File(cDbf + ".dbf" ) )
			Assert.True( File(cDbf + ".cdx" ) )
			Assert.False( File(cDbf) )
			DbCloseArea()
			
		RETURN
		

		[Fact, Trait("Category", "DBF")];
		METHOD CDX_test() AS VOID
			LOCAL aValues AS ARRAY
			LOCAL i AS DWORD
			LOCAL cDBF, cCDX AS STRING
			
			RddSetDefault("DBFCDX")

			aValues := { "ssss" , "hhhh", "wwww" , "aaaa" }
			cDBF := GetTempFileName()
			cCDX := cDbf
			FErase(cCdx + ".cdx")
			DbCreate( cDBF , {{"LAST" , "C" , 20 , 0 } , ;
								{"TEXT1" , "C" , 10 , 0 } , ;
								{"NUM1" , "N" , 10 , 2 }})
			
			DbUseArea(,,cDBF,,FALSE)
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut(1,aValues [i])
			NEXT
			DbCreateIndex(cCDX, "Upper ( Last)")
			DbCloseArea()
			
			DbUseArea(,,cDBF,,TRUE) // open shared !
			DbSetIndex(cCDX)
			DbGoTop()
			? "current (indexed) order"
			DO WHILE ! Eof()
				? FieldGet ( 1 )
				DbSkip ( 1 )
			ENDDO
			DbGoTop()
			// "now replace the index field #LAST content 'aaaa' with 'pppp'"
			// "and also update another field"
			Assert.True( DbRLock ( RecNo() )  )
			// "Replacing", AllTrim(FieldGet(1)), "with 'pppp'"
			FieldPut ( 1 , "pppp" ) // Note: This is the index field
				
//	 this is what causes the problem, updating a second field
//	 if this fieldput is put above the first one, then sample works correctly
//	 either one of the fieldputs below cause the problem to surface
			FieldPut ( 2 , "Eins" )
			FieldPut ( 3 , 123.45 )
			
			DbCommit()
			
			DbRUnLock ( RecNo() )
			
			Assert.False( DbSeek( "AAAA" ) ) // must show .F.
			Assert.True( DbSeek ("PPPP" ) ) // must show .T.
			// "Record order now:"
			// "(should be hhhh, pppp, ssss , wwww)"
			DbGoTop()
			LOCAL nCount := 0 AS INT
			DO WHILE ! Eof()
				? AllTrim(FieldGet(1)) , FieldGet(3) , AllTrim(FieldGet(2))
				nCount ++
				DO CASE
				CASE nCount == 1
					Assert.Equal( "hhhh", AllTrim(FieldGet(1)) )
				CASE nCount == 2
					Assert.Equal( "pppp", AllTrim(FieldGet(1)) )
				CASE nCount == 3
					Assert.Equal( "ssss", AllTrim(FieldGet(1)) )
				CASE nCount == 4
					Assert.Equal( "wwww", AllTrim(FieldGet(1)) )
				END CASE
				DbSkip ( 1 )
			ENDDO
			DbCloseArea()
		RETURN
	
	
		[Fact, Trait("Category", "DBF")];
		METHOD DBOrderInfo_DBOI_KEYCOUNT() AS VOID
			DBOrderInfo_DBOI_KEYCOUNT_helper(TRUE)
			DBOrderInfo_DBOI_KEYCOUNT_helper(FALSE)
		RETURN
		PRIVATE METHOD DBOrderInfo_DBOI_KEYCOUNT_helper(lUseIndexFormVO AS LOGIC) AS VOID
			LOCAL cDbf AS STRING
			LOCAL aValues AS ARRAY 
			LOCAL i AS DWORD
			
			RddSetDefault("DBFCDX")

			cDBF := GetTempFileName("testcdx")
			FErase(cDbf + ".cdx")
			
			aValues := { 44 , 12, 34 , 21 }                                 
			DbCreate( cDBF , {{"AGE" , "N" , 3 , 0 } })
			DbUseArea(,"DBFCDX",cDBF,,FALSE) 
			Assert.Equal(0 , (INT) DbOrderInfo( DBOI_KEYCOUNT ) ) // 0,  ok
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut(1,aValues [i])  
			NEXT 
			Assert.Equal(0 , (INT) DbOrderInfo( DBOI_KEYCOUNT ) ) // 0,  ok

			IF lUseIndexFormVO
				System.IO.File.WriteAllBytes(cDbf + ".cdx" , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAQD//////////90B//8AAA8PEAQEAwAGIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRFU1RDRFg1AAoAAAAAAAAAAAAACABgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAABAAAABABhZ2UAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMABAD//////////9cB//8AAA8PEAQEAwIAYAQAYQMAYQEAYQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZBNcAo"))
			ELSE
				DbCreateIndex(cDbf, "age" ) 
			END IF
			DbCloseArea()

			DbUseArea(,"DBFCDX",cDBF,,FALSE) 
			DbSetOrder(1)
			Assert.Equal(4 , (INT) DbOrderInfo( DBOI_KEYCOUNT ) ) // 4, correct
			DbGoTop() 
			Assert.Equal(4 , (INT) DbOrderInfo( DBOI_KEYCOUNT ) ) // 4, correct
			DO WHILE ! Eof()
//			? FieldGet ( 1 ) 
				DbSkip(1)
			ENDDO 
			Assert.Equal(4 , (INT) DbOrderInfo( DBOI_KEYCOUNT ) ) // NIL, should be 4
			DbSkip(-1)
			Assert.Equal(4 , (INT) DbOrderInfo( DBOI_KEYCOUNT ) ) // 4, correct
			DbCloseArea ()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD SetDeleted_FALSE() AS VOID
			SetDeleted_FALSE_helper(TRUE)
			SetDeleted_FALSE_helper(FALSE)
		RETURN
		PRIVATE METHOD SetDeleted_FALSE_helper(lUseIndexFormVO AS LOGIC) AS VOID
			LOCAL cDbf AS STRING
			LOCAL aValues AS ARRAY 
			LOCAL i AS DWORD
			
			cDBF := GetTempFileName("testcdx")
			FErase(cDbf + ".cdx")
		
			RddSetDefault("DBFCDX")
			SetDeleted(FALSE)
			
//			test also with those
//			aValues := { "vaa" , "abba", "acb" , "aaab"  , "adab"  , "baac"  , "aeab"  , "baaAaa" }
			aValues := { "vvv" , "abb", "acb" , "aaa"  , "bbb" }
			DbCreate( cDBF , {{"LAST" , "C" ,10 , 0 } })
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut(1,aValues [i])  
			NEXT 
			Assert.Equal(0 , (INT)DbOrderInfo( DBOI_KEYCOUNT ))
			IF lUseIndexFormVO
				DbCloseArea()
				System.IO.File.WriteAllBytes(cDbf + ".cdx" , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAQD//////////90B//8AAA8PEAQEAwAGIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRFU1RDRFg2AAoAAAAAAAAAAAAACgBgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAABAAAADABVcHBlcihMQVNUKQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMABQD//////////8wB//8AAA8PEAQEAwQAcAIAcQMAcQUAcAEAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABWVlZCQkJDQkJCQUFB"))
			ELSE
				DbCreateIndex(cDbf, "Upper(LAST)" ) 
				DbCloseArea()
			END IF
		
			DbUseArea(,"DBFCDX",cDBF,,TRUE) 
			DbSetOrder(1)
			Assert.Equal(5 , (INT)DbOrderInfo( DBOI_KEYCOUNT ))
			// ? "Setting scope"
			LOCAL u AS USUAL
			u := "A"
			VoDbOrderInfo( DBOI_SCOPETOP, "", NIL, REF u )
			VoDbOrderInfo( DBOI_SCOPEBOTTOM, "", NIL, REF u )
		
			DbGoTop()
			Assert.Equal(4 , (INT)RecNo())
			DbGoBottom()
			Assert.Equal(3 , (INT)RecNo())
		
			DbGoTop() 
		
			Assert.Equal(3 , (INT)DbOrderInfo( DBOI_KEYCOUNT ))
			DO WHILE ! Eof()
				DbSkip(1)
			ENDDO 
			Assert.Equal(3 , (INT)DbOrderInfo( DBOI_KEYCOUNT ))
			DbCloseArea()

			SetDeleted(FALSE)
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD SetDeleted_TRUE() AS VOID
			SetDeleted_TRUE_helper(TRUE)
			SetDeleted_TRUE_helper(FALSE)
		RETURN
		PRIVATE METHOD SetDeleted_TRUE_helper(lUseIndexFormVO AS LOGIC) AS VOID
			LOCAL cDbf AS STRING
			LOCAL aValues AS ARRAY 
			LOCAL i AS DWORD
			
			RddSetDefault("DBFCDX")

			cDBF := GetTempFileName("testcdx")
			FErase(cDbf + ".cdx")
		
			SetDeleted(TRUE)
			
//			test also with those
//			aValues := { "vaa" , "abba", "acb" , "aaab"  , "adab"  , "baac"  , "aeab"  , "baaAaa" }
			aValues := { "vvv" , "abb", "acb" , "aaa"  , "bbb" }
			DbCreate( cDBF , {{"LAST" , "C" ,10 , 0 } })
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut(1,aValues [i])  
			NEXT 
			Assert.Equal(0 , (INT)DbOrderInfo( DBOI_KEYCOUNT ))
			DbCloseArea()

			IF lUseIndexFormVO
				System.IO.File.WriteAllBytes(cDbf + ".cdx" , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAQD//////////90B//8AAA8PEAQEAwAGIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRFU1RDRFg2AAoAAAAAAAAAAAAACgBgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAABAAAADABVcHBlcihMQVNUKQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMABQD//////////8wB//8AAA8PEAQEAwQAcAIAcQMAcQUAcAEAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABWVlZCQkJDQkJCQUFB"))
				DbUseArea(,"DBFCDX",cDBF,,TRUE) 
			ELSE
				DbUseArea(,"DBFCDX",cDBF,,TRUE) 
				DbCreateIndex(cDbf, "Upper(LAST)" ) 
			END IF
		
			DbSetOrder(1)
			Assert.Equal(5 , (INT)DbOrderInfo( DBOI_KEYCOUNT ))
			// ? "Setting scope"
			LOCAL u AS USUAL
			u := "A"
			VoDbOrderInfo( DBOI_SCOPETOP, "", NIL, REF u )
			VoDbOrderInfo( DBOI_SCOPEBOTTOM, "", NIL, REF u )
		
			DbGoTop()
			Assert.Equal(4 , (INT)RecNo())
			DbGoBottom()
			Assert.Equal(3 , (INT)RecNo())
		
			DbGoTop() 
		
			Assert.Equal(3 , (INT)DbOrderInfo( DBOI_KEYCOUNT ))
			DO WHILE ! Eof()
				DbSkip(1)
			ENDDO 
			Assert.Equal(3 , (INT)DbOrderInfo( DBOI_KEYCOUNT ))
			DbCloseArea()

			SetDeleted(FALSE)
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD DBOrderInfo_DBOI_NUMBER() AS VOID
			DBOrderInfo_DBOI_NUMBER_helper(TRUE)
			DBOrderInfo_DBOI_NUMBER_helper(FALSE)
		RETURN
		PRIVATE METHOD DBOrderInfo_DBOI_NUMBER_helper(lUseIndexFormVO AS LOGIC) AS VOID
			LOCAL aValues AS ARRAY
			LOCAL i AS DWORD
			LOCAL cDBF AS STRING
			LOCAL cCdx AS STRING

			RddSetDefault("DBFCDX")

			aValues := { 44 , 12, 34 , 21 }                                
			cDBF := GetTempFileName("testcdx8")
			cCdx := cDbf + ".cdx"
			FErase(cCdx)
			IF System.IO.File.Exists(cCdx)
				System.IO.file.Delete(cCdx)
			END IF
			DbCreate( cDBF , {{"AGE" , "N" , 3 , 0 } })                                        
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			Assert.Equal(0, (INT)DbOrderInfo( DBOI_KEYCOUNT ) )   //  0  ok
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut(1,aValues [i]) 
			NEXT
			Assert.Equal(0, (INT)DbOrderInfo( DBOI_KEYCOUNT ) ) //  0 ,ok
			Assert.Equal(0, (INT)DbOrderInfo( DBOI_NUMBER ) )  //  -1,  but should show 0


			IF lUseIndexFormVO
				System.IO.File.WriteAllBytes(cDbf + ".cdx" , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAQD//////////90B//8AAA8PEAQEAwAGIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRFU1RDRFg4AAoAAAAAAAAAAAAACABgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAABAAAABABhZ2UAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMABAD//////////9cB//8AAA8PEAQEAwIAYAQAYQMAYQEAYQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZBNcAo"))
			ELSE
				DbCreateIndex( cCdx, "age" )
			END IF
			DbCloseArea()
			
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			DbSetOrder(1)
			
			DbGoTop()
			DO WHILE ! Eof()
//				? FieldGet ( 1 )
				DbSkip(1)
			ENDDO

			Assert.True( DbClearIndex(, cCdx) )

			DbGoTop()
			Assert.Equal(1, (INT)RecNo())

			Assert.True( DbSetIndex ( cCdx ) )

			Assert.Equal(4, (INT) DbOrderInfo( DBOI_KEYCOUNT ) ) // 4, ok
			Assert.Equal(1, (INT) DbOrderInfo( DBOI_NUMBER ) )  // still  -1 , but should show  1
			Assert.Equal("TESTCDX8", (STRING) DbOrderInfo( DBOI_NAME ) )  // ok , "TESTDBF"
			DbCloseArea ()
		RETURN


		[Fact, Trait("Category", "DBF")];
			METHOD DBSetOrderCondition_test() AS VOID
			LOCAL cDbf AS STRING
			LOCAL aValues AS ARRAY
			LOCAL i AS DWORD
			
			RddSetDefault("DBFCDX")

			cDBF := GetTempFileName()
			FErase(cDbf + ".cdx")
			aValues := { 1,4,2,3 }
			DbCreate( cDBF , {{"NUM" , "N" ,5 , 0 } })
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut(1,aValues [i])
			NEXT
			DbGoTop()
			
			// DESCENDING = TRUE
			Assert.True( DbSetOrderCondition(,,,,,,,,,,TRUE) )
			Assert.True( DbCreateIndex(cDbf, "NUM" ) )
			
			DbGoTop()
			aValues := { 4,3,2,1 }
			LOCAL nCount := 0 AS INT
			DO WHILE .NOT. EoF()
				nCount ++
				Assert.Equal((INT)aValues[nCount] , (INT)FieldGet(1))
				DbSkip()
			END DO
			
			DbCloseArea()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD Fields_Named_After_Funcs() AS VOID
			LOCAL cDbf AS STRING
			cDBF := GetTempFileName()
			FErase(cDbf + ".cdx")
			
			RddSetDefault("DBFCDX")

			DbCloseAll() // worakaroudn for previous test crashing
			
			DbCreate( cDBF , {{"LEFT" , "N" ,5 , 0 } , {"STR" , "C" ,5 , 0 } })
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			DbAppend()
			FieldPut(1,1)
			FieldPut(2,"A")
			DbAppend()
			FieldPut(1,11)
			FieldPut(2,"B")
			DbGoTop()
			Assert.True( DbCreateIndex(cDbf, "STR" ) )
			Assert.True( DbSetFilter(&("{||LEFT<10}")) )
			DbGoTop()
			DbSkip()
			Assert.True( Eof() )
			DbCloseArea()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD Uninitialized_fields() AS VOID
			LOCAL cDbf AS STRING

			RddSetDefault("DBFCDX")

			DbCloseAll()
			
			cDBF := GetTempFileName()
			FErase(cDbf + ".cdx")
			DbCreate( cDBF , {{"FIELDN" , "N" ,5 , 0 } })
			DbUseArea(,"DBFCDX",cDBF)
			DbAppend()
			FieldPut(1,1)
			DbAppend() // no field assigned
			DbCloseArea()
			
			DbUseArea(,"DBFCDX",cDBF)
			Assert.True( DbCreateIndex(cDbf, "FIELDN" ) )
			DbCloseArea()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD DBOrderInfo_DBOI_KEYTYPE() AS VOID
			LOCAL cDbf AS STRING
			DbCloseAll()
			
			RddSetDefault("DBFCDX")

			cDBF := GetTempFileName("testnewer")
			FErase(cDbf + ".cdx")
			DbCreate( cDBF , {{"FIELDN" , "N" ,5 , 0 } , ;
			{"FIELDS" , "C" ,15 , 0 } , ;
			{"FIELDL" , "L" ,1 , 0 } , ;
			{"FIELDD" , "D" ,8 , 0 } })
			DbUseArea(,"DBFCDX",cDBF)
			DbAppend()
			FieldPut(1,1)
			DbCloseArea()
			
			DbUseArea(,"DBFCDX",cDBF)
			DbCreateIndex(cDbf + ".cdx", "FIELDN" )
			Assert.Equal(3, (INT)DbOrderInfo( DBOI_KEYTYPE ) ) // 14 (), should be 3 (FLOAT)
			DbCloseArea()
			FErase(cDbf + ".cdx")
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			DbCreateIndex(cDbf + ".cdx", "FIELDS" )
			Assert.Equal(7, (INT)DbOrderInfo( DBOI_KEYTYPE ) ) // 18 (PTR), should be 7 (STRING)
			FErase(cDbf + ".cdx")
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			DbCreateIndex(cDbf + ".cdx", "FIELDD" )
			Assert.Equal(2, (INT)DbOrderInfo( DBOI_KEYTYPE ) ) // 16, should be 2 (DATE)
			FErase(cDbf + ".cdx")
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			DbCreateIndex(cDbf + ".cdx", "FIELDL" )
			Assert.Equal(8, (INT)DbOrderInfo( DBOI_KEYTYPE ) ) // 3 (FLOAT), should be 8
			
			DbCloseArea()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD DBSetOrderCondition_with_FOR() AS VOID
			DBSetOrderCondition_with_FOR_helper(TRUE)
			DBSetOrderCondition_with_FOR_helper(FALSE)
		RETURN
		PRIVATE METHOD DBSetOrderCondition_with_FOR_helper(lUseIndexFormVO AS LOGIC) AS VOID
			LOCAL cDbf AS STRING
			DbCloseAll()
			
			RddSetDefault("DBFCDX")

			cDBF := GetTempFileName("testcdx9")
			FErase(cDbf + ".cdx")
			
			DbCreate( cDBF , {{"FIELDN" , "N" ,5 , 0 } })
			DbUseArea(,"DBFCDX",cDBF) 
			DbAppend()
			FieldPut(1,1)
			DbAppend()
			FieldPut(1,4)
			DbAppend()
			FieldPut(1,2)
			DbAppend()
			FieldPut(1,3)
			DbCloseArea()
			
			IF lUseIndexFormVO
				System.IO.File.WriteAllBytes(cDbf + ".cdx" , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAQD//////////90B//8AAA8PEAQEAwAGIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRFU1RDRFg5AAoAAAAAAAAAAAAACABoAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEABwAJAAAABwBGSUVMRE4ARklFTEROPjIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAgD//////////98B//8AAA8PEAQEAwQAYAIAYQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEMAI"))
				DbUseArea(,"DBFCDX",cDBF) 
			ELSE
				DbUseArea(,"DBFCDX",cDBF) 
				DbSetOrderCondition( "FIELDN>2",{||_FIELD->FIELDN>2},,,,,,,,, TRUE)
				DbCreateIndex(cDbf, "FIELDN" )
			END IF
		
			// Should show only 4,3, but it shows all records 4,3,2,1
			Assert.True( DbSetOrder(1) )
			DbGoTop()
			LOCAL nCount := 0 AS INT
			DO WHILE .NOT. EoF()
				nCount ++
				IF nCount == 1
					Assert.Equal(4 ,(INT)FieldGet(1))
				ELSEIF nCount == 1
					Assert.Equal(3 ,(INT)FieldGet(1))
				END IF
				DbSkip()
			END DO
		    
			Assert.Equal(2 ,nCount)
			
			// Should both show true, but both return false
			Assert.True( DbOrderInfo( DBOI_ISCOND ) )
			Assert.True( DbOrderInfo( DBOI_ISDESC ) )
			
			DbCloseArea()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD DBSetFound_test() AS VOID
			LOCAL aDbf AS ARRAY
			LOCAL cDbf AS STRING

			RddSetDefault("DBFCDX")

			DbCloseAll()
			
			cDBF := GetTempFileName("testcdx1")
			FErase(cDbf + ".cdx")
			aDbf := {{ "AGE" , "N" , 2 , 0 }}
			DbCreate( cDBF , aDbf)
			
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			DbAppend()
			
			Assert.False( Found() )// FALSE, ok
			Assert.True( DbSetFound( FALSE ) )
			Assert.False( Found() ) // TRUE! wrong
			Assert.True( DbSetFound( TRUE ) )
			Assert.True( Found() ) // TRUE correct
			DbCloseArea()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD DBSetFound_test2() AS VOID
			LOCAL aDbf AS ARRAY
			LOCAL cDbf AS STRING

			RddSetDefault("DBFCDX")

			DbCloseAll()
			
			cDBF := GetTempFileName("testcdx1")
			FErase(cDbf + ".cdx")
			aDbf := {{ "AGE" , "N" , 2 , 0 }}
			DbCreate( cDBF , aDbf)
			
		    DbCreate( cDBF , aDbf)
		    DbUseArea(,"DBFCDX",cDBF,,FALSE)
		   
		    DbAppend()
		   
		    DbCloseArea()
		   
		    DbUseArea( TRUE ,"DBFCDX",cDBF,"AREA1" ,TRUE )
		    DbUseArea( TRUE ,"DBFCDX",cDBF,"AREA2" ,TRUE )
		    
		    Assert.True( DbSelectArea ( "AREA1" ) )
		    Assert.Equal("AREA1", Alias() )
		    Assert.False( Found() )
		    Assert.True( DbSetFound ( TRUE ) )
		    Assert.True( Found() )
		   
		    Assert.True( DbSelectArea ( "AREA2" ) )
		    Assert.Equal( "AREA2" , Alias() )
		    Assert.False( Found() )
		    Assert.True( DbSetFound  ( FALSE ) )
		    Assert.False( Found() )

		    Assert.True( DbCloseArea() )
		    Assert.True( DbSelectArea ( "AREA1" ) )
		    Assert.True( DbCloseArea() )
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD DBSetFound_test3() AS VOID
			LOCAL aDbf AS ARRAY
			LOCAL cDbf AS STRING

			RddSetDefault("DBFCDX")

			DbCloseAll()
			
			cDBF := GetTempFileName("testcdx1")
			FErase(cDbf + ".cdx")
		    aDbf := {{ "AGE" , "N" , 2 , 0 }}
		    DbCreate( cDBF , aDbf)
		    DbUseArea(,,cDBF,,FALSE)
		   
		    DbAppend()
		    FieldPut(1,1)
		    DbCloseArea()
		   
		    DbUseArea( TRUE ,"DBFCDX",cDBF,"AREA1" ,TRUE )
		    DbUseArea( TRUE ,"DBFCDX",cDBF,"AREA2" ,TRUE )
		    
		    DbSelectArea ( "AREA1" )  
		    Assert.True( DbLocate({||_FIELD->AGE == 1}) )
		    Assert.True( Found() )
		   
		    DbSelectArea ( "AREA2" )   
		    Assert.False( Found() )
		
		    DbCloseAll()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD FLock_test() AS VOID
			LOCAL aDbf AS ARRAY
			LOCAL cDbf AS STRING
			
			RddSetDefault("DBFCDX")
			
			DbCloseAll()
			
			cDBF := __FUNCTION__
			FErase(cDbf + ".cdx")
			
		    aDbf := {{ "AGE" , "N" , 2 , 0 }}
			DbCreate( cDBF , aDbf)

			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			DbAppend()
			DbAppend()
			DbAppend()
			DbCloseArea()
			
			Assert.True( DbUseArea( TRUE ,"DBFCDX",cDBF,"AREA1" ,TRUE ) )// open shared
			DbGoTop()
			Assert.True( DbRLock ( RecNo() ) ) // lock first record
			Assert.Equal( 1 , (INT) ALen ( DbRLockList() ) )
			
			Assert.True( DbUseArea( TRUE ,"DBFCDX",cDBF,"AREA2" ,TRUE ) ) // open shared
			DbGoBottom()
			Assert.True( DbRLock ( RecNo() ) ) // lock last record
			Assert.Equal( 1 , (INT) ALen ( DbRLockList() ) )
			
			Assert.False( Flock() )
			// what's the correct return value here??
			// Assert.Equal( 0 , (INT) ALen ( DBRLockList() ) )
			DbCloseAll()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD IndexExt_test() AS VOID
			LOCAL aDbf AS ARRAY
			LOCAL cDBF AS STRING
			LOCAL aValues AS ARRAY
			LOCAL i AS DWORD       

			RddSetDefault("DBFCDX")

			DbCloseAll()
			
			cDBF := __FUNCTION__
			FErase(cDbf + ".cdx")

			RddSetDefault("DBFCDX")
			Assert.True( IndexKey() == "")
			Assert.True( IndexOrd() == 0)
			Assert.True( IndexCount() == 0)
			Assert.True( Upper(IndexExt()) ==  ".CDX")
			Assert.True( DbOrderInfo(DBOI_INDEXEXT) == NIL )
			
			aValues := { 44 , 12, 34 , 21 }
			aDbf := {{ "AGE" , "N" , 2 , 0 }}
			
			DbCreate( cDBF , aDbf)
			DbUseArea(,"DBFCDX",cDBF,,FALSE)                    
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut(1,aValues [i])
			NEXT    
			DbCreateIndex( cDbf, "age" )
			
			Assert.Equal( "age" , (STRING) IndexKey() )
			Assert.True( IndexOrd() == 1 )
			Assert.True( IndexCount() == 1 )
			Assert.True( Upper(IndexExt()) == ".CDX")
			Assert.True( DbOrderInfo(DBOI_INDEXEXT) == ".CDX")
			
			DbCloseArea()
		RETURN


		[Fact, Trait("Category", "DBF")];
		METHOD Cdx_Multi_Order() AS VOID
			Cdx_Multi_Order_helper(1)
			Cdx_Multi_Order_helper(2)
			Cdx_Multi_Order_helper(3)
		RETURN
		PRIVATE METHOD Cdx_Multi_Order_helper(nTestType AS INT) AS VOID
			LOCAL aValues AS ARRAY
			LOCAL i AS DWORD
			LOCAL cDbf AS STRING
			LOCAL cCdx AS STRING
			LOCAL d AS DATE
			d := ConDate(2019,02,22)
			
			cDBF := GetTempFileName("testcdx")
			aValues := { {44,d} , {12,d-1}, {34,NULL_DATE} , {21,d+1} }                                
			
			RddSetDefault("DBFCDX")
			cCdx := cDbf + ".cdx"
			FErase(cCdx)
			DbCreate( cDbf , {{"FIELDN" , "N" , 3 , 0 } , {"FIELDD" , "D" , 8 , 0 } })                                        
			DbUseArea(,"DBFCDX",cDBF,,FALSE)
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut(1,aValues [i,1]) 
				FieldPut(2,aValues [i,2]) 
			NEXT
			DbCloseArea()
			
			IF nTestType == 1
				System.IO.File.WriteAllBytes(cDbf + ".cdx" , Convert.FromBase64String("AAQAAAAAAAAAAAAACgDgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAwD//////////88B//8AAA8PEAQEAwASQAAMNQAGIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABURVNUQ0RYOE4yRklFTEREAAoAAAAAAAAAAAAACABgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwABAAAABwBGSUVMRE4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMABAD//////////9cB//8AAA8PEAQEAwIAYAQAYQMAYQEAYQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZBNcAoABAAAAAAAAAAAAAACABgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAABAAAACAAtRklFTEROAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMABAD//////////78B//8AAA8PEAQEAwEAAAMAAQQAAQIAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANf////////K////////vv///////z+5////////ABYAAAAAAAAAAAAACABgAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwABAAAABwBGSUVMREQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMABAD//////////9UB//8AAA8PEAQEAwMAcAIAQAEANAQAQwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADVgMFCwdSA"))
				DbUseArea(,"DBFCDX",cDBF,,FALSE)
			ELSEIF nTestType == 2
				DbUseArea(,"DBFCDX",cDBF,,FALSE)
				DbCreateIndex( cCdx, "FIELDN" )
				DbCreateOrder("FIELDN2", cCdx, "-FIELDN" )
				DbCreateOrder("FIELDD", cCdx, "FIELDD" )
                DbSetOrder(1)
			ELSE
				DbUseArea(,"DBFCDX",cDBF,,FALSE)
				DbCreateIndex( cCdx, "FIELDN" )
				DbCreateOrder("FIELDN2", cCdx, "-FIELDN" )
				DbCreateOrder("FIELDD", cCdx, "FIELDD" )

				DbCloseArea()
				DbUseArea(,"DBFCDX",cDBF,,FALSE)
			END IF

			
			LOCAL nCount := 0 AS INT

			DbGoTop()
			DO WHILE .NOT. EOF()
				nCount ++
				DO CASE
				CASE nCount == 1
					Assert.True(RecNo() == 2)
				CASE nCount == 2
					Assert.True(RecNo() == 4)
				CASE nCount == 3
					Assert.True(RecNo() == 3)
				CASE nCount == 4
					Assert.True(RecNo() == 1)
				END CASE
//				? FieldGet(1), FieldGet(2) , RecNo()
				DbSkip()
			ENDDO
			
			nCount := 0
			DbSetOrder(1)
			DbGoTop()
			DO WHILE .NOT. EOF()
				nCount ++
				DO CASE
				CASE nCount == 1
					Assert.True(RecNo() == 2)
				CASE nCount == 2
					Assert.True(RecNo() == 4)
				CASE nCount == 3
					Assert.True(RecNo() == 3)
				CASE nCount == 4
					Assert.True(RecNo() == 1)
				END CASE
//				? FieldGet(1), FieldGet(2) , RecNo()
				DbSkip()
			ENDDO
			
			nCount := 0
			DbSetOrder(2)
			DbGoTop()
			DO WHILE .NOT. EOF()
				nCount ++
				DO CASE
				CASE nCount == 1
					Assert.True(RecNo() == 1)
				CASE nCount == 2
					Assert.True(RecNo() == 3)
				CASE nCount == 3
					Assert.True(RecNo() == 4)
				CASE nCount == 4
					Assert.True(RecNo() == 2)
				END CASE
//				? FieldGet(1), FieldGet(2) , RecNo()
				DbSkip()
			ENDDO
			
			nCount := 0
			DbSetOrder(3) 
			DbGoTop()
			DO WHILE .NOT. EOF()
				nCount ++
				DO CASE
				CASE nCount == 1
					Assert.True(RecNo() == 3)
				CASE nCount == 2
					Assert.True(RecNo() == 2)
				CASE nCount == 3
					Assert.True(RecNo() == 1)
				CASE nCount == 4
					Assert.True(RecNo() == 4)
				END CASE
//				? FieldGet(1), FieldGet(2) , RecNo()
				DbSkip()
			ENDDO
			
			DbCloseArea()
		RETURN
		

		// TECH-5YYVPE1A8T, DBFCDX StackOverflow with Shared mode, DBSelete() and DBUnlock()
		[Fact, Trait("Category", "DBF")];
		METHOD DBFCDX_StackOverflow() AS VOID
			LOCAL cDBF AS STRING
			
            TRY
			RddSetDefault("DBFCDX")
			SetExclusive( FALSE )
			
			cDBF := GetTempFileName()
			FErase(cDBF)
			FErase(cDBF + ".cdx")
			
			DbfTests.CreateDatabase(cDBF , { { "CFIELD" , "C" , 5 , 0 }} , { "AAA" , "CCC" , "BBB" } )
			DbCreateIndex(cDbf , "CFIELD")
			DbCloseAll()
			
			DbUseArea(,"DBFCDX",cDBF )
			DbGoTop()
			DbSkip()
			
			Assert.Equal( 3, (INT) RecNo() )
			Assert.Equal( "BBB  ", FieldGet(1) )
			
			Assert.True( DbRLock()  )
			Assert.True( DbDelete() )
			Assert.True( DbUnLock() ) // StackOverflow here
			
            FINALLY
			DbCloseAll()
            SetExclusive ( TRUE )
            END TRY
		RETURN


		// TECH-545T6VKW27, Problems with OrdScope() and DBSeek()
		[Fact, Trait("Category", "DBF")];
		METHOD OrdScope_and_DBSeek_test() AS VOID
			LOCAL cDBF AS STRING
			LOCAL aFields, aValues AS ARRAY
			LOCAL i AS DWORD
			
			RddSetDefault("DBFCDX")
			
			cDbf := GetTempFileName()
			FErase(cDbf + ".cdx")
			
			aValues := {"Gas" , "Abc", "Golden" , "Guru" , "Ddd" , "Aaa" , "Ggg"}
			aFields := { {"CFIELD" , "C" , 10 , 0} }
			
			DbCreate(cDbf , aFields)
			DbUseArea(,,cDBF )
			DbCreateIndex(cDbf , "Upper(CFIELD)")
			FOR i := 1 UPTO ALen(aValues)
				IF DbAppend()
				    FieldPut(1, aValues[i])
                ENDIF
			NEXT
			
			DbGoTop()
            DbCommit()
			Assert.Equal(7 , (INT) DbOrderInfo( DBOI_KEYCOUNT ) ) // 7, correct
			
			// Setting order scope
			OrdScope(TOPSCOPE, "G")
			OrdScope(BOTTOMSCOPE, "G")
			DbGoTop()
			
			// VO: -2 with NTX, 4 with CDX
			Assert.Equal(4 , (INT) DbOrderInfo( DBOI_KEYCOUNT ) )
			
			Assert.True( DbSeek("G")    ) // TRUE, correct
			Assert.True( DbSeek("GOLD") ) // TRUE with NTX, FALSE with CDX. VO TRUE in both
			
			// Clearing order scope
			OrdScope(TOPSCOPE, NIL)
			OrdScope(BOTTOMSCOPE, NIL)
			Assert.Equal( 7 , (INT) DbOrderInfo( DBOI_KEYCOUNT ) )
			Assert.True( DbSeek("G") )
			Assert.True( DbSeek("GOLD") )
			
			// Setting order scope again
			OrdScope(TOPSCOPE, "G")
			OrdScope(BOTTOMSCOPE, "G")
			DbGoTop()
			// VO: -2 with NTX, 4 with CDX
			Assert.Equal(4 , (INT) DbOrderInfo( DBOI_KEYCOUNT ) )
			
			Assert.True( DbSeek("G")    ) // TRUE, correct
			Assert.True( DbSeek("GOLD") ) // TRUE with NTX, FALSE with CDX. VO TRUE in both
			
			DbCloseArea()
		RETURN



		// TECH-6010F6ZSY9, DBFCDX OrdDescend() not working
		[Fact, Trait("Category", "DBF")];
		METHOD DBFCDX_OrdDescend_test() AS VOID
			LOCAL cDBF, cIndex AS STRING
			LOCAL aFields, aValues AS ARRAY
			LOCAL i AS DWORD
			
			RddSetDefault ( "DBFCDX" )
			aFields := { { "LAST" , "C" , 20 , 0 }}
			aValues := { "b" , "d" , "c", "e" , "a" }
			cDBF := GetTempFileName()
			FErase ( cDbf + IndexExt() )
			cIndex := cDbf + "x"
			FErase ( cIndex + IndexExt() )
//			 -----------------
			DbCreate( cDBF , AFields)
			DbUseArea(,"DBFCDX",cDBF )
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut ( 1 , aValues [ i ] )
			NEXT
			
			DbCreateOrder ( "ORDER1" , cIndex , "upper(LAST)" , { || Upper(_FIELD->LAST) } )
			DbSetOrder ( 1 )
			
			Assert.False( DbOrderInfo(DBOI_ISDESC) ) // false, correct
			Assert.False( OrdDescend() ) // true, incorrect

			DbGoTop()
			LOCAL aResult AS ARRAY
			LOCAL nIndex AS INT
			aResult := {5,1,3,2,4}
			nIndex := 0
			DO WHILE ! Eof()
//				5,1,3,2,4 correct
				nIndex ++
				Assert.Equal((INT) aResult[nIndex] , (INT) RecNo() )
				DbSkip(1)
			ENDDO
			
			Assert.False( OrdDescend ( ,, TRUE ) )
			Assert.True( DbOrderInfo(DBOI_ISDESC) ) // false, wrong
			Assert.True( OrdDescend() )
			
			DbGoTop()
			aResult := {4,2,3,1,5}
			nIndex := 0
			DO WHILE ! Eof()
//				5,1,3,2,4 again, wrong, should be 4,2,3,1,5
				nIndex ++
				Assert.Equal((INT) aResult[nIndex] , (INT) RecNo() )
				DbSkip(1)
			ENDDO

			DbCloseAll()
		RETURN


		// TECH-8H9WL71978, OrdIsUnique() always returns TRUE
		[Fact, Trait("Category", "DBF")];
		METHOD OrdIsUnique_test() AS VOID
			LOCAL cDBF, cIndex AS STRING
			LOCAL aFields, aValues AS ARRAY
			LOCAL i AS DWORD
			LOCAL lUnique AS LOGIC

			lUnique := SetUnique()
			RddSetDefault ( "DBFCDX" )
			
			aFields := { { "LAST" , "C" , 20 , 0 }}
			aValues := { "a" , "d" , "f", "c" }
			
			cDBF := GetTempFileName()
			cIndex := cDbf
			
			FErase ( cIndex + IndexExt() )
//			 -----------------
			DbCreate( cDBF , AFields)
			DbUseArea(,"DBFCDX",cDBF )
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut ( 1 , aValues [ i ] )
			NEXT
			
			Assert.True( OrdCondSet() )
			Assert.True( OrdCreate(cIndex, "ORDER1", "upper(LAST)", { || Upper ( _FIELD-> LAST) } ) )
			DbSetOrder ( 1 )
			Assert.Equal( "ORDER1" , OrdName() ) // "ORDER1"
			Assert.False( OrdIsUnique() ) // always returns true !
			Assert.False( DbOrderInfo(DBOI_UNIQUE ) ) // ok
			Assert.False( DbOrderInfo(DBOI_ISDESC ) ) // ok
			
			Assert.True( OrdCondSet() )
//			 create a descend and unique order
			Assert.True( OrdCondSet(,,,,,,,,,,TRUE) )
			SetUnique ( TRUE )
			OrdCreate(cIndex, "ORDER2", "upper(LAST)", { || Upper ( _FIELD-> LAST) } )
			
			DbSetOrder ( 2 )
			Assert.Equal( "ORDER2" , OrdName() ) // "ORDER2"
			Assert.True( OrdIsUnique() ) // always returns true !
			Assert.True( DbOrderInfo(DBOI_UNIQUE ) ) // ok
			Assert.True( DbOrderInfo(DBOI_ISDESC ) ) // ok
			DbCloseAll()
			Assert.True( SetUnique ( lUnique ) )
		RETURN


		// TECH-679F75W648, Cannot create custom DBFCDX index
		[Fact, Trait("Category", "DBF")];
		METHOD Custom_DBFCDX_test() AS VOID
			LOCAL cDBF, cIndex AS STRING
			LOCAL aFields, aValues AS ARRAY
			LOCAL i AS DWORD
			
			RddSetDefault ( "DBFCDX" )
			
			aFields := { { "LAST" , "C" , 20 , 0 }}
			
			aValues := { "Goethe" , "Goldmann" , "Ober",;
			"Osterreich" , "Gothe" , "Gotz" , "Gobel" ,;
			"Otter" , "Anfang" , "Art" , "Arger" }
			
			cDBF := __FUNCTION__
			cIndex := cDbf
			FErase ( cIndex + IndexExt() )

			DbCreate( cDBF , AFields)
			DbUseArea(,"DBFCDX",cDBF )
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut ( 1 , aValues [ i ] )
			NEXT
			
			FOR i := 1 UPTO 2
				DbSetOrderCondition()
				IF i == 2
//					 second order should be a custom order.
					DbSetOrderCondition(,,,,,,,,,,,,, TRUE)
				ENDIF
				DbCreateOrder ( "ORDER"+ NTrim(i) , cIndex , "upper(LAST)" , { ||Upper ( _FIELD->LAST) } )
//				? OrdCreate(cIndex, "ORDER"+NTrim(i), "upper(LAST)", { || Upper ( _Field->LAST) } ) // ok
			NEXT

			DbSetOrder ( 1 )
			Assert.Equal( "ORDER1", OrdName() ) // "ORDER1" ok
			Assert.Equal( 1 , (INT) OrdNumber() ) // 1 ok
			Assert.Equal( "upper(LAST)" ,  OrdKey(1) ) // "UPPER(LAST)" ok
			Assert.False( (LOGIC) DbOrderInfo ( DBOI_CUSTOM ) ) // returns FALSE ok
			Assert.Equal( 11 , (INT) DbOrderInfo ( DBOI_KEYCOUNT ) ) // ok, shows 11
			Assert.Equal( 11 , (INT) OrdKeyCount( 1 , cIndex ) ) // ok, shows 11
			Assert.Equal( 11 , (INT) OrdKeyCount( "ORDER1" , cIndex) ) // ok, shows 11
			Assert.Equal( 11 , (INT) OrdKeyCount( 1 ) )
			Assert.Equal( 11 , (INT) OrdKeyCount() )
			
			DbSetOrder ( 2 )
			Assert.Equal( "ORDER2", OrdName() ) // "ORDER2" ok
			Assert.Equal( 2 , (INT) OrdNumber() ) // 2 ok
			Assert.Equal( "upper(LAST)" ,  OrdKey(2) ) // "UPPER(LAST)" ok
			Assert.True( (LOGIC) DbOrderInfo ( DBOI_CUSTOM ) ) // NOTE: returns FALSE instead of TRUE
			Assert.Equal( 0 , (INT) DbOrderInfo ( DBOI_KEYCOUNT ) ) // NOTE: shows 11 instead of 0
			Assert.Equal( 0 , (INT) OrdKeyCount( 2 , cIndex ) ) // NOTE: shows 11 instead of 0
			Assert.Equal( 0 , (INT) OrdKeyCount( "ORDER2" , cIndex) ) // NOTE: shows 11 instead of 0
			Assert.Equal( 0 , (INT) OrdKeyCount( 2 ) )
			Assert.Equal( 0 , (INT) OrdKeyCount() )
			
			Assert.Equal( 2 , (INT) IndexCount() ) // 2 ok
			
//			 NOTE: ORDDESTROY() problem. if the order doesnt exist the func returns TRUE and
//			 seems to do nothing. VO throws an error if a order doesnexist.
			LOCAL lException := FALSE AS LOGIC
			TRY
				OrdDestroy("ORDER4") // NOTE: "ORDER4" does not exist
			CATCH
				lException := TRUE
				Assert.Equal( 2 , (INT) IndexCount() )
				Assert.Equal( 2 , (INT) IndexOrd() )
			END TRY
			Assert.True( lException )
			DbCloseAll()
		RETURN


		// TECH-679F75W648, Cannot create custom DBFCDX index
		[Fact, Trait("Category", "DBF")];
		METHOD Custom_DBFCDX_test2() AS VOID
			#warning Custom order test not added, feature is not supported yet
/*
			LOCAL cDBF, cPfad, cIndex, cDriver AS STRING
			LOCAL aFields, aValues AS ARRAY
			LOCAL i AS DWORD
			LOCAL aRecnos AS ARRAY
			
			cDriver := RDDSetDefault ( "DBFCDX" )
			
			aFields := { { "LAST" , "C" , 20 , 0 }}
			
			aValues := { "Goethe" , "Goldmann" , "Ober",;
			"Osterreich" , "Gothe" , "Gotz" , "Gobel" ,;
			"Otter" , "Anfang" , "Art" , "Arger" }
			
			cPfad := "" // "c:\xide\projects\project1\bin\debug\"
			cDBF := cPfad + "Foo"
			cIndex := cPfad + "Foox"
			
			FErase ( cIndex + IndexExt() )
//			 -----------------
			? DBCreate( cDBF , AFields)
			? DBUseArea(,"DBFCDX",cDBF )
			
			FOR i := 1 UPTO ALen ( aValues )
			DBAppend()
			FieldPut ( 1 , aValues [ i ] )
			NEXT
			
			FOR i := 1 UPTO 2
			DBSetOrderCondition()
			IF i == 2
			DBSetOrderCondition(,,,,,,,,,,,,, TRUE)
			ENDIF
			
//			 ? DBCREATEORDER ( "ORDER"+ NTrim(i) , cIndex ,"upper(LAST)" , { || Upper ( _Field->LAST) } )
			? OrdCreate(cIndex, "ORDER"+ NTrim(i), "upper(LAST)", { || Upper (_Field->LAST) } )
			NEXT
			
//			 -------------
			?
			? IndexCount() // ok 2
			? OrdName() // ok current order is "ORDER2"
			? OrdKeyCount() // 0 before OrdKeyAdd()
			?
			
//			 add 4 records to the custom order
			aRecnos := { 1 , 11 , 4 , 9 }
			FOR i := 1 UPTO ALen ( aRecnos )
			DBGoTo ( aRecnos [ i ] )
			OrdKeyAdd ()
			NEXT
			? OrdKeyCount() // 4 after OrdKeyAdd()
			?
			
			DBGoTop()
			
//			 "Last" names shown are:
//			 Anfang
//			 Arger
//			 Gothe
//			 Osterreich
			
			DO WHILE ! EOF()
			? FieldGet ( 1 ) , RecNo()
			DBSkip(1)
			ENDDO
			?
//			
			? "Delete the entry 'Arger'"
			DBSeek( Upper ( "Arger" ))
			OrdKeyDel () // delete the entry
			? OrdKeyCount() // 3
			?
			DBGoTop()
			
//			 "Last" names shown are now:
//			 Anfang
//			 Gothe
//			 Osterreich
			
			DO WHILE ! EOF()
			? FieldGet ( 1 ) , RecNo()
			DBSkip(1)
			ENDDO
			?
			? "Delete all entries"
			
			DBGoTop()
			DO WHILE OrdKeyCount() > 0
			OrdKeyDel()
			DBGoTop()
			ENDDO
			
			? "Entries now:" , OrdKeyCount()
			?
//			 "ORDER2" order is no longer needed
			? OrdDestroy("ORDER2")
			? IndexCount() // 1
			?
//			 --- switch to the first order ---
			? DBSetOrder ( 1 )
			? OrdName() // ok "ORDER1"
			?
//			 List all "Last" names
			DBGoTop()
			
			DO WHILE ! EOF()
			? FieldGet ( 1 ) , RecNo()
			DBSkip(1)
			ENDDO
			
			DBCloseAll()
			RDDSetDefault ( cDriver )*/
		RETURN


		// TECH-5OD246EMC4, VODBOrdListAdd() fails when index filename passed without extension
		[Fact, Trait("Category", "DBF")];
		METHOD VODBOrdListAdd_test() AS VOID
			LOCAL cDBF, cIndex AS STRING
			LOCAL aFields, aValues AS ARRAY
			LOCAL i AS DWORD
			
			RddSetDefault("DBFCDX")
			aFields := { { "LAST" , "C" , 20 , 0 }}
			aValues := { "b" , "c" , "d", "e" , "a" }
			
			cDBF := __FUNCTION__
			cIndex := cDbf
			FErase ( cIndex + IndexExt() )
			
			DbCreate( cDBF , AFields)
			DbUseArea(,,cDBF)
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut ( 1 , aValues [ i ] )
			NEXT
			DbCreateOrder ( "ORDER1" , cIndex , "upper(LAST)" , { || Upper (_FIELD->LAST) } )
			DbCloseAll()
			
//			 When ".cdx" is added SetIndex() returns true
//			 cIndex := cIndex + IndexExt()
			DbUseArea(,,cDBF)
			Assert.True( VoDbOrdListAdd(cIndex , NIL) ) // Returns FALSE, error
			DbCloseAll()
		RETURN


		// TECH-0YI914Z4I2, Problem opening dbf with dbt via SetDefault()
		[Fact, Trait("Category", "DBF")];
		METHOD SetDefault_test() AS VOID
			LOCAL cPath, cDbf AS STRING
			LOCAL cDefault AS STRING
			RddSetDefault("DBFCDX")
			
			cPath := System.IO.Path.GetTempPath()
			IF .NOT. cPath:EndsWith("\")
				cPath += "\"
			END IF
			cDbf := "fpttest"
			FErase(cPath + cDBF + ".dbf")
			FErase(cPath + cDBF + ".ntx")
			FErase(cPath + cDBF + ".cdx")
			FErase(cPath + cDBF + ".dbt")
			FErase(cPath + cDBF + ".fpt")
			
			cDefault := GetDefault()
			SetDefault(cPath)
			
			Assert.True( DbCreate( cPath + cDbf , { { "ID" , "C" , 5 , 0 } , {"MEM" , "M" , 10 , 0}} ) )
//			 System.IO.FileNotFoundException
//			 Could not find file '<path_of_exe>\mydbf.DBT'.
			Assert.True( DbUseArea(,,cDbf ) )
			Assert.True( DbCloseArea()      )
			
			SetDefault(cDefault)
		RETURN


		// TECH-ZW8D1S87CH, Problem updating cdx
		[Fact, Trait("Category", "DBF")];
		METHOD CdxUpdating() AS VOID
			LOCAL cDBF AS STRING
			LOCAL aFields, aValues AS ARRAY 
			LOCAL cPrev AS STRING
			LOCAL nCount AS INT
			LOCAL i AS DWORD
			
			RddSetDefault ( "DBFCDX" )
			
			aFields := { { "NUM" , "N" , 8 , 0 },{ "LAST" , "C" , 100 , 0 }} 
			aValues := { "b" , "c" , "d", "e" , "a" , "r" , "t" , "g" , "m" , "n" , "t" , "b" , "h" , "f" , "y", "r", "t", "y", "z", "v", "e", "r", "b", "z", "b", "m", "w", "e" }
			
			cDBF := GetTempFileName()
			FErase ( cDbf + IndexExt() )       
			
			DbCreate( cDBF , AFields)
			DbUseArea(,,cDBF )
			FOR i := 1 UPTO ALen ( aValues )
				DbAppend()
				FieldPut ( 1 , i )                                      
				FieldPut ( 2 , Replicate( aValues [ i ] , 50) )
			NEXT
			DbCreateIndex ( cDBF , "NUM" , {||_FIELD->NUM})
			DbCreateOrder ( "LAST" , cDBF , "LAST" , {||_FIELD->LAST})
			DbCloseAll()
			
			
			DbUseArea(,,cDBF )
			DbSetOrder(2)
			DbGoBottom()
			
			FieldPut(2, "a")
			DbSkip(-5)
			FieldPut(2, "d")
			DbSkip(5)
			FieldPut(2, "z")
			
			
			cPrev := NULL
			nCount := 0
			DbGoTop()
			DO WHILE .NOT. EoF()
				nCount ++
				IF cPrev != NULL
					Assert.True( cPrev <= FieldGet(2) )
				END IF
				cPrev := FieldGet(2)
				DbSkip()
			END DO
			Assert.Equal( nCount, (INT) ALen(aValues) )
	
			DbCloseArea()
		RETURN
		
	
		// TECH-78PAZ508AE, Problems with creating/opening DBFCDX memo files
		[Fact, Trait("Category", "DBF")];
		METHOD MemoCreateAndOpen() AS VOID
			LOCAL aFields AS ARRAY
			LOCAL cDBF AS STRING
			
			RddSetDefault("DBFCDX")
			cDBF := System.IO.Path.GetTempPath() + "cdxtest"

			aFields := { { "LAST" , "C" , 20 , 0 } , { "COMMENTS" , "M" , 10 , 0 }}
			FErase(cDBF + ".cdx")
			FErase(cDBF + ".dbt")
			FErase(cDBF + ".fpt")
			
			DbCreate( cDBF , AFields)
//			DBCreate( cDBF , AFields , "DBFCDX") // same
			
			Assert.False( (LOGIC) File(cDBF + ".dbt") )
			Assert.True( (LOGIC) File(cDBF + ".fpt") )
			
			IF File(cDBF + ".dbt")
				FRename(cDBF + ".dbt",cDBF + ".fpt")
			END IF

			TRY
				DbUseArea(,,cDBF)
			FINALLY
				DbCloseAll()
			END TRY


			RddSetDefault("DBFNTX")
			cDBF := System.IO.Path.GetTempPath() + "ntxtest"

			aFields := { { "LAST" , "C" , 20 , 0 } , { "COMMENTS" , "M" , 10 , 0 }}
			FErase(cDBF + ".dbt")
			FErase(cDBF + ".fpt")
			
			DbCreate( cDBF , aFields)
			
			Assert.True( (LOGIC) File(cDBF + ".dbt") )
			Assert.False( (LOGIC) File(cDBF + ".fpt") )
			
			IF File(cDBF + ".fpt")
				FRename(cDBF + ".fpt",cDBF + ".dbt")
			END IF

			TRY
				DbUseArea(,,cDBF)
			FINALLY
				DbCloseAll()
			END TRY
		RETURN		



		[Fact, Trait("Category", "DBF")];
		METHOD CDX_DBGoTop() AS VOID
			LOCAL aFields AS ARRAY
			LOCAL cDBF AS STRING
			
			RddSetDefault("DBFCDX")
			cDBF := System.IO.Path.GetTempPath() + "cdxtest1"

			aFields := { { "LAST" , "C" , 20 , 0 }}
			FErase(cDBF + ".cdx")
			FErase(cDBF + ".dbt")
			FErase(cDBF + ".fpt")
			
			DbCreate( cDBF , AFields)

			DbUseArea(,"DBFCDX" , cDbf)
			FOR LOCAL n := 1 AS INT UPTO 1000
				DbAppend()
				FieldPut(1,"A"+AsString(n % 77))
			NEXT
			DbCreateOrder( "ORDER1" , cDbf + ".cdx" , "upper(LAST)" , { || Upper ( _FIELD->LAST) }  )
			DbCloseArea()
			
			LOCAL nCount AS INT
			DbUseArea(,"DBFCDX" , cDbf)

			DbGoTop()
			DbGoTop()
			nCount := 0
			DO WHILE .NOT. Eof()
				nCount ++
				DbSkip()
			END DO
			Assert.Equal( nCount, 1000 )

			DbGoBottom()
			DbGoBottom()
			nCount := 0
			DO WHILE .NOT. Bof()
				nCount ++
				DbSkip(-1)
			END DO
			Assert.Equal( nCount, 1000 )
			DbCloseArea()
		RETURN		

        [Fact, Trait("Category", "DBF")];
		METHOD CDX_SeekEmptyDbf() AS VOID
			LOCAL aFields AS ARRAY
			LOCAL cDBF AS STRING
			
			RddSetDefault("DBFCDX")
			cDBF := GetTempFileName()

			aFields := { { "LAST" , "C" , 20 , 0 }}
			FErase(cDBF + ".cdx")
			FErase(cDBF + ".dbt")
			FErase(cDBF + ".fpt")
			
			DbCreate( cDBF , AFields)

			DbUseArea(,"DBFCDX" , cDbf)
			DbCreateOrder( "ORDER1" , cDbf + ".cdx" , "upper(LAST)" , { || Upper ( _FIELD->LAST) }  )

			DbGoTop()
            DbSeek("A")
			DbCloseArea()

		RETURN	

		STATIC PRIVATE METHOD GetTempFileName() AS STRING
           STATIC nCounter AS LONG
            ++nCounter
		    RETURN GetTempFileName("testcdx"+Ntrim(nCounter))
		    
		STATIC PRIVATE METHOD GetTempFileName(cFileName AS STRING) AS STRING
			// we may want to put them to a specific folder etc
		RETURN cFileName
			
	END CLASS
END NAMESPACE
