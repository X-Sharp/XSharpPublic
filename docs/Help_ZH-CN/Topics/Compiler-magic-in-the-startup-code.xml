<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="../helpproject.xsl" ?>
<topic template="Default" modified="2024-07-26T12:07:31.838+08:00" lasteditedby="niuji" version="2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../helpproject.xsd">
  <title>启动代码中的编译器魔法</title>
  <keywords>
    <keyword>$AppExit</keyword>
    <keyword>$AppInit</keyword>
    <keyword>$Exit</keyword>
    <keyword>$Init1</keyword>
    <keyword>$Init2</keyword>
    <keyword>$Init3</keyword>
    <keyword>EXIT PROCEDURE</keyword>
    <keyword>INIT PROCEDURE</keyword>
  </keywords>
  <body>
    <header>
      <para styleclass="Heading1">启动代码中的编译器魔法</para>
    </header>
    <para styleclass="Body Text">X# 编译器还会在启动代码中做一些额外的 &quot;手脚&quot;。</para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text">XBase 代码可能有所谓的 INIT 过程，其中包含启动时将执行的代码。例如，在 VO GUI 类中有一个过程 </para>
    <para styleclass="Code Example"><text style="font-weight:bold; font-style:normal; color:#ff0000;">PROCEDURE</text><text style="font-weight:normal; font-style:normal; color:#000000;"> __WCInitCriticalSections() _INIT1</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">为确保在启动时调用这些程序，编译器会在函数类中生成一至三个特殊方法，名称分别为 $Init1、$Init2、$Init3 和 $Exit。VOGuiclasses 程序集中有两个这样的方法($Init1 和 $Init3)。在 ILSpy 中查看该方法的内容，可以看到如下内容(使用 C# 反编译)</text></para>
    <para styleclass="Code Example"><text style="font-weight:normal; font-style:italic; color:#000000;">// VOGUIClasses.Functions</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">using</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">System.Runtime.CompilerServices;</text><br/><br/><text style="font-weight:normal; font-style:normal; color:#000000;">[CompilerGenerated]</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">public</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">static</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">void</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">$Init1()</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">{</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:normal; font-style:normal; color:#000000;">__WCInitCriticalSections();</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">}</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">在某些程序集中，你会发现 $Init1() 方法是存在的，但却是空的。例如，在 VOSystemClasses：</text></para>
    <para styleclass="Code Example"><text style="font-weight:normal; font-style:italic; color:#000000;">// VOSystemClasses.Functions</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">using</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">System.Runtime.CompilerServices;</text><br/><br/><text style="font-weight:normal; font-style:normal; color:#000000;">[CompilerGenerated]</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">public</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">static</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">void</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">$Init1()</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">{</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">}</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">我们创建这些空初始化器的原因如下：</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">我们的许多 VO 客户都是通过调用 CreateInstance() 来间接实例化类的。</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">要做到这一点，类必须在运行时可用。</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">我们使用的 Roslyn 编译器非常聪明。当 exe 不引用外部程序集中的任何类型或方法时，编译器不会将外部程序集的引用包含到 exe 中。</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">因此，如果您在应用程序中调用 CreateInstance(#DbServer)，但从未声明 DbServer 类型的变量(例如，仅声明 DataServer 类型的变量)，那么即使您在编译时包含对 VORDDClasses 程序集的引用，您的主应用程序中也不会包含对 RDDClasses 的引用。</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">这就是我们生成空 $Init() 方法的原因。</text></para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">在生成主程序时，X# 编译器会检查所有引用的程序集，并查找所有 $Init1、$Init2、$Init3 和 $Exit 方法，然后生成一些代码来调用所有这些方法。因此，所有引用的程序集都将在启动时加载。您可以在编译器生成的 &lt;module&gt; 类中的特殊编译器生成方法中找到这段启动代码：</text></para>
    <para styleclass="Code Example"><text style="font-weight:normal; font-style:italic; color:#000000;">// &lt;Module&gt;</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">using</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">Application1.Exe;</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">using</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">System;</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">using</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">System.Runtime.CompilerServices;</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">using</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">VOWin32APILibrary;</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">using</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">XSharp;</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">using</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">XSharp.RT;</text><br/><br/><text style="font-weight:normal; font-style:normal; color:#000000;">[CompilerGenerated]</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">internal</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">static</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">void</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">$AppInit()</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">{</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:bold; font-style:normal; color:#000000;">try</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:normal; font-style:normal; color:#000000;">{</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">RuntimeState.AppModule</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">=</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">typeof</text><text style="font-weight:normal; font-style:normal; color:#000000;">(Application1.Exe.Functions).Module;</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">RuntimeState.CompilerOptionOVF</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">=</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">false</text><text style="font-weight:normal; font-style:normal; color:#000000;">;</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">RuntimeState.CompilerOptionVO11</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">=</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">false</text><text style="font-weight:normal; font-style:normal; color:#000000;">;</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">RuntimeState.CompilerOptionVO13</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">=</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">false</text><text style="font-weight:normal; font-style:normal; color:#000000;">;</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">RuntimeState.Dialect</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">=</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">XSharpDialect.VO;</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">VOWin32APILibrary.Functions.$Init1();</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">XSharp.RT.Functions.$Init1();</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">Application1.Exe.Functions.$Init1();</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:normal; font-style:normal; color:#000000;">}</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:bold; font-style:normal; color:#000000;">catch</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">(Exception</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">innerException)</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:normal; font-style:normal; color:#000000;">{</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:bold; font-style:normal; color:#000000;">throw</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">new</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">Exception(&quot;Error when executing code in INIT procedure(s)&quot;,</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">innerException);</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:normal; font-style:normal; color:#000000;">}</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">}</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">正如您所看到的，这段代码不仅调用了几个 $Init1() 方法，还在 X# 运行时中设置了一些属性。您还可以看到，上面的代码是在 VO Dialect 中调用的。</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">如果查看 Start 函数的生成代码，它看起来是这样的：</text></para>
    <para styleclass="Code Example"><text style="font-weight:normal; font-style:italic; color:#000000;">// Application1.Exe.Functions</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">using</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">System;</text><br/><text style="font-weight:bold; font-style:normal; color:#000000;">using</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">XSharp.RT;</text><br/><br/><text style="font-weight:bold; font-style:normal; color:#000000;">public</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">static</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:bold; font-style:normal; color:#000000;">void</text><text style="font-weight:normal; font-style:normal; color:#ffffff;"> </text><text style="font-weight:normal; font-style:normal; color:#000000;">Start()</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">{</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:bold; font-style:normal; color:#000000;">try</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:normal; font-style:normal; color:#000000;">{</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">&lt;Module&gt;.$AppInit();</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">XSharp.RT.Functions.QOut(&quot;Function Start&quot;);</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:normal; font-style:normal; color:#000000;">}</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:bold; font-style:normal; color:#000000;">finally</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:normal; font-style:normal; color:#000000;">{</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">&lt;Module&gt;.$AppExit();</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">GC.Collect();</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">        </text><text style="font-weight:normal; font-style:normal; color:#000000;">GC.WaitForPendingFinalizers();</text><br/><text style="font-weight:normal; font-style:normal; color:#ffffff;">    </text><text style="font-weight:normal; font-style:normal; color:#000000;">}</text><br/><text style="font-weight:normal; font-style:normal; color:#000000;">}</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">编译器创建了一个 try finally 块，并调用 $AppInit() 来初始化运行时状态并调用每个引用程序集中的 init 过程。</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">您还可以看到，在 finally 子句中调用了 $AppExit()，其中调用了 EXIT 程序(我们在 X# 中添加了这些程序)，垃圾回收器会清除所有引用，并在应用程序结束前等待所有最终程序结束。</text></para>
    <para styleclass="Body Text"></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">遗憾的是，这并不意味着所有打开的服务器都会关闭。如果您打开了一个 DbServer 并将该对象赋值给一个全局变量，那么它并不会自动关闭服务器。</text></para>
    <para styleclass="Body Text"><text style="font-weight:normal; font-style:normal; color:#000000;">运行时中有一些代码会处理这个问题(但这是另一个主题)......</text></para>
    <para styleclass="Body Text"></para>
  </body>
</topic>
